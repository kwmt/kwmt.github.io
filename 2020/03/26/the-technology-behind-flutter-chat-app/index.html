
<!DOCTYPE html>
<html lang="ja">

    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" Flutter製チャットアプリを支える技術 &middot;  Androg" />
        <meta property="og:site_name" content="Androg" />
        <meta property="og:url" content="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" />

        

  
    <meta name="twitter:card" content="summary"/>
  
  
  <meta property="og:url" content="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/"/>
  <meta property="og:type" content="article"/>
  <meta property="og:title" content="Flutter製チャットアプリを支える技術 - Androg"/>
  <meta property="og:description" content="はじめに 今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったりFlutter温泉に行ったり、今年の後半はFlutter三昧でした。
そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。
開発環境は下記のとおりです。
% flutter doctor Doctor summary (to see all details, run flutter doctor -v): [✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP) [✓] Android toolchain - develop for Android devices (Android SDK 28.0.3) [✓] iOS toolchain - develop for iOS devices (Xcode 10.1) [✓] Android Studio (version 3.2) [✓] VS Code (version 1.29.1) [✓] Connected device (2 available)  まずどんな機能を作ったか？ 大きく分けると次のようになるかなと思います。"/>
  
  <meta name="twitter:title" content="Flutter製チャットアプリを支える技術 - Androg"/>
  <meta name="twitter:description" content="はじめに 今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったりFlutter温泉に行ったり、今年の後半はFlutter三昧でした。
そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。
開発環境は下記のとおりです。
% flutter doctor Doctor summary (to see all details, run flutter doctor -v): [✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP) [✓] Android toolchain - develop for Android devices (Android SDK 28.0.3) [✓] iOS toolchain - develop for iOS devices (Xcode 10.1) [✓] Android Studio (version 3.2) [✓] VS Code (version 1.29.1) [✓] Connected device (2 available)  まずどんな機能を作ったか？ 大きく分けると次のようになるかなと思います。"/>
  
  
  

    

        <title> Flutter製チャットアプリを支える技術 &middot;  Androg</title>

    
        <meta name="description" content="" />
    

        <meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
        

    
        <link href="https://kwmt27.net/index.xml" rel="alternate" type="application/rss+xml" title="Androg" />
    

    
        <link rel="canonical" href="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" />

    
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Flutter製チャットアプリを支える技術",
        "author": {
            "@type": "Person",
            "name": "http://profiles.google.com/?rel=author"
        },
        "datePublished": "2020-03-26",
        "description": "",
        "wordCount": 1679
    }
    </script>
    

    
    
    <link rel="stylesheet" href="https://kwmt27.net//css/crisp.css" type="text/css" />

    
    
    
    <script src="https://apis.google.com/js/platform.js" async defer>
      {lang: 'ja'}
    </script>

    
    <script data-ad-client="ca-pub-3131366896030715" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body>

        
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5&appId=221529537867804";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
        </script>

        <header id="header">
            <a id="logo" href="https://kwmt27.net/"><img src="https://ja.gravatar.com/userimage/93860812/00b6ee3c5005fbd5ca9a4571908ce3ee.jpg?size=200" alt="Androg" /></a>
            <h1><a href="https://kwmt27.net/">Androg</a></h1>
            <p></p>

            <div id="follow-icons">
	
	<a href="http://twitter.com/kwmt27" rel="me"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	<a href="http://github.com/kwmt" rel="me"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="http://plus.google.com/+YasutakaKawamoto" rel="author"><i class="fa fa-google-plus-square fa-2x"></i></a>
	<a href="https://kwmt27.net/index.xml" rel="me"><i class="fa fa-rss-square fa-2x"></i></a> 
</div>  
            

            <div class="tags">
                <div>タグ</div>
                <span class="taglist">
                    
                        <a href="https://kwmt27.net//tags/1.2/">
                            <div>1.2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/1.2-rc1/">
                            <div>1.2-rc1<span class="badge">12</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/adb/">
                            <div>adb<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/advent-calendar/">
                            <div>advent-calendar<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/ambient/">
                            <div>ambient<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/android/">
                            <div>android<span class="badge">87</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/android-n/">
                            <div>android-n<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/android-studio/">
                            <div>android-studio<span class="badge">7</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/android-studio-3.6/">
                            <div>android-studio-3.6<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/android-wear/">
                            <div>android-wear<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/androiddevchallenge/">
                            <div>androiddevchallenge<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/androidstudio/">
                            <div>androidstudio<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/android%e7%a0%94%e7%a9%b6%e7%99%ba%e8%a1%a8%e4%bc%9a/">
                            <div>android研究発表会<span class="badge">3</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/animation/">
                            <div>animation<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/archive/zip/">
                            <div>archive/zip<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/arduino/">
                            <div>arduino<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/aws/">
                            <div>aws<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/beacon/">
                            <div>beacon<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/billing/">
                            <div>billing<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/bitmap/">
                            <div>bitmap<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/camera2/">
                            <div>camera2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/camerax/">
                            <div>camerax<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/cd/">
                            <div>cd<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/ci/">
                            <div>ci<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/ci/cd/">
                            <div>ci/cd<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/clean-architecture/">
                            <div>clean-architecture<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/cloud-vision-api/">
                            <div>cloud-vision-api<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/codelab/">
                            <div>codelab<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/compose/">
                            <div>compose<span class="badge">11</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/compress/bzip2/">
                            <div>compress/bzip2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/coroutine/">
                            <div>coroutine<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/css/">
                            <div>css<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/dagger2/">
                            <div>dagger2<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/dark-theme/">
                            <div>dark-theme<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/dart/">
                            <div>dart<span class="badge">5</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/dart2/">
                            <div>dart2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/databinding/">
                            <div>databinding<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/deeplearning/">
                            <div>deeplearning<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/delegate/">
                            <div>delegate<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/docker/">
                            <div>docker<span class="badge">3</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/eclipse/">
                            <div>eclipse<span class="badge">3</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/encoding/base64/">
                            <div>encoding/base64<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/encoding/json/">
                            <div>encoding/json<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/enum/">
                            <div>enum<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/fabric-sdk/">
                            <div>fabric-sdk<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/fcm/">
                            <div>fcm<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/firebase/">
                            <div>firebase<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/firestore/">
                            <div>firestore<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/flow/">
                            <div>flow<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/flutter/">
                            <div>flutter<span class="badge">28</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/flutter_inapp_purchase/">
                            <div>flutter_inapp_purchase<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/flutter_web/">
                            <div>flutter_web<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/gae/go/">
                            <div>gae/go<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/gcm/">
                            <div>gcm<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/gdgkobe/">
                            <div>gdgkobe<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/gds/">
                            <div>gds<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/genmai/">
                            <div>genmai<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/gin/">
                            <div>gin<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/git/">
                            <div>git<span class="badge">4</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/go/">
                            <div>go<span class="badge">4</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/gocon/">
                            <div>gocon<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/godoc/">
                            <div>godoc<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/golang/">
                            <div>golang<span class="badge">57</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/google&#43;api/">
                            <div>google&#43;api<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/google-i/o-2018/">
                            <div>google-i/o-2018<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/google-mapa-api/">
                            <div>google-mapa-api<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/google-maps-api/">
                            <div>google-maps-api<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/google-play/">
                            <div>google-play<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/google-signin/">
                            <div>google-signin<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/googlei/o-2019/">
                            <div>googlei/o-2019<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/googlemap/">
                            <div>googlemap<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/go%e8%a8%80%e8%aa%9e/">
                            <div>go言語<span class="badge">53</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/greendao/">
                            <div>greendao<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/heroku/">
                            <div>heroku<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/hugo/">
                            <div>hugo<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/icon/">
                            <div>icon<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/image/">
                            <div>image<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/intellij-idea/">
                            <div>intellij-idea<span class="badge">4</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/ios/">
                            <div>ios<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/java/">
                            <div>java<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/jenkins/">
                            <div>jenkins<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/jetpack/">
                            <div>jetpack<span class="badge">13</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/jquery/">
                            <div>jquery<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/json-schema/">
                            <div>json-schema<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/kotlin/">
                            <div>kotlin<span class="badge">7</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/kug2/">
                            <div>kug2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/layout/">
                            <div>layout<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/lifecycle/">
                            <div>lifecycle<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/line/">
                            <div>line<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/linebot/">
                            <div>linebot<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/lint/">
                            <div>lint<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/livedata/">
                            <div>livedata<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/lt/">
                            <div>lt<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/macos/">
                            <div>macos<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/map/">
                            <div>map<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/mockito2/">
                            <div>mockito2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/mysql/">
                            <div>mysql<span class="badge">4</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/navigation/">
                            <div>navigation<span class="badge">3</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/net/http/fcgi/">
                            <div>net/http/fcgi<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/net/smtp/">
                            <div>net/smtp<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/nginx/">
                            <div>nginx<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/node.js/">
                            <div>node.js<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/okhttp/">
                            <div>okhttp<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/openid/">
                            <div>openid<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/oreo/">
                            <div>oreo<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/package/">
                            <div>package<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/php/">
                            <div>php<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/pil/">
                            <div>pil<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/plant-uml/">
                            <div>plant-uml<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/polymer/">
                            <div>polymer<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/provider/">
                            <div>provider<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/push%e9%80%9a%e7%9f%a5/">
                            <div>push通知<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/python/">
                            <div>python<span class="badge">4</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/pythonchallenge/">
                            <div>pythonchallenge<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/reflect/">
                            <div>reflect<span class="badge">7</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/retrofit/">
                            <div>retrofit<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/retrofit2/">
                            <div>retrofit2<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/riot.js/">
                            <div>riot.js<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/room/">
                            <div>room<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/runtime/">
                            <div>runtime<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/rxjava/">
                            <div>rxjava<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/s3/">
                            <div>s3<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/sensor/">
                            <div>sensor<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/server/">
                            <div>server<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/sketch/">
                            <div>sketch<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/state/">
                            <div>state<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/statusbar/">
                            <div>statusbar<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/strconv/">
                            <div>strconv<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/strings/">
                            <div>strings<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/struct/">
                            <div>struct<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/sublime-text/">
                            <div>sublime-text<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/swift/">
                            <div>swift<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/swiftui/">
                            <div>swiftui<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/targetsdkversiion/">
                            <div>targetsdkversiion<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/template/">
                            <div>template<span class="badge">4</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/tensorflow/">
                            <div>tensorflow<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/test/">
                            <div>test<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/textformfield/">
                            <div>textformfield<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/topic/">
                            <div>topic<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/twitter/">
                            <div>twitter<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/unicode/utf8/">
                            <div>unicode/utf8<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/vagrant/">
                            <div>vagrant<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/view-binding/">
                            <div>view-binding<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/viewmodel/">
                            <div>viewmodel<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/volley/">
                            <div>volley<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/vps/">
                            <div>vps<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/web-api/">
                            <div>web-api<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/webview/">
                            <div>webview<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/wercker/">
                            <div>wercker<span class="badge">3</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/wercker-step/">
                            <div>wercker-step<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/windows/">
                            <div>windows<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/wordpress/">
                            <div>wordpress<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/xcode/">
                            <div>xcode<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/y/">
                            <div>y<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%82%a2%e3%83%97%e3%83%aa%e5%86%85%e8%aa%b2%e9%87%91/">
                            <div>アプリ内課金<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%82%a4%e3%83%99%e3%83%b3%e3%83%88/">
                            <div>イベント<span class="badge">9</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%82%a8%e3%83%9f%e3%83%a5%e3%83%ac%e3%83%bc%e3%82%bf/">
                            <div>エミュレータ<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%82%b7%e3%83%a7%e3%83%bc%e3%83%88%e3%82%ab%e3%83%83%e3%83%88%e3%82%ad%e3%83%bc/">
                            <div>ショートカットキー<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%82%b7%e3%83%b3%e3%82%bf%e3%83%83%e3%82%af%e3%82%b9%e3%83%8f%e3%82%a4%e3%83%a9%e3%82%a4%e3%83%88/">
                            <div>シンタックスハイライト<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%82%b9%e3%82%af%e3%83%ad%e3%83%bc%e3%83%ab/">
                            <div>スクロール<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%83%88%e3%83%a9%e3%83%83%e3%82%af%e3%83%90%e3%83%83%e3%83%89/">
                            <div>トラックバッド<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%83%97%e3%83%a9%e3%82%a4%e3%83%90%e3%82%b7%e3%83%bc%e3%83%9d%e3%83%aa%e3%82%b7%e3%83%bc/">
                            <div>プライバシーポリシー<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%83%a1%e3%83%ab%e3%83%81%e3%83%a3%e3%83%aa/">
                            <div>メルチャリ<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e3%83%a2%e3%83%90%e3%82%82%e3%81%8f%e4%bc%9a/">
                            <div>モバもく会<span class="badge">7</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e4%bd%93%e9%a8%93/">
                            <div>体験<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e5%8b%89%e5%bc%b7%e4%bc%9a/">
                            <div>勉強会<span class="badge">10</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e6%8c%af%e3%82%8a%e8%bf%94%e3%82%8a/">
                            <div>振り返り<span class="badge">8</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e6%97%85%e8%a1%8c%e8%a8%98/">
                            <div>旅行記<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e6%97%a5%e8%a8%98/">
                            <div>日記<span class="badge">13</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e6%a9%9f%e4%bc%9a%e5%ad%a6%e7%bf%92/">
                            <div>機会学習<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e6%a9%9f%e6%a2%b0%e5%ad%a6%e7%bf%92/">
                            <div>機械学習<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e7%99%bb%e5%a3%87/">
                            <div>登壇<span class="badge">2</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e7%bf%bb%e8%a8%b3/">
                            <div>翻訳<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e8%a7%92%e4%b8%b8/">
                            <div>角丸<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e8%a8%ad%e5%ae%9a%e5%88%87%e3%82%8a%e6%9b%bf%e3%81%88/">
                            <div>設定切り替え<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e9%96%a2%e3%83%a2%e3%83%90/">
                            <div>関モバ<span class="badge">1</span></div>
                        </a>
                    
                        <a href="https://kwmt27.net//tags/%e9%98%aago/">
                            <div>阪go<span class="badge">2</span></div>
                        </a>
                    
                </span>
            </div>


        </header>

<main id="content">

<article id="" class="post">
    <div class="post-stamp">
        <time datetime="2020-03-26T02:00:00&#43;09:00">
            26 Mar 2020
        </time>
        <span class="taglist">
        
        &middot; 
        
            <a href="https://kwmt27.net/tags/flutter/">Flutter</a>
        
        
        </span>
    </div>
    <h1 class="post-title">Flutter製チャットアプリを支える技術</h1>

    <div id="share-top">
    <ul class="clearfix">
        
        <li>
            <a href="http://b.hatena.ne.jp/entry/https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" class="hatena-bookmark-button"
               data-hatena-bookmark-title="Flutter製チャットアプリを支える技術" data-hatena-bookmark-layout="standard-balloon"
               data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img
                    src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加"
                    width="20" height="20" style="border: none;"/></a>
            <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8"
                    async="async"></script>

        </li>
        
        
        <li>
            <div class="g-plusone" data-href="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/"></div>
        </li>

        
        <li>

            <div class="fb-like" data-href="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" data-layout="button_count" data-action="like"
                 data-show-faces="false" data-share="false"></div>
        </li>

        
        <li>
            <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
            <script type="text/javascript">
                !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");
            </script>
        </li>

    </ul>
</div>
    <div id="ad">
    <aside>
        <p>スポンサーリンク</p>
        <div class="responsive-unit">
            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3131366896030715"
                 data-ad-slot="5415567707"
                 data-ad-format="auto"></ins>
            <script>
(adsbygoogle = window.adsbygoogle || []).push({});

            </script>
        </div>
    </aside>
</div>
    

<h1 id="はじめに">はじめに</h1>

<p>今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったり<a href="https://gdg.connpass.com/event/98013/">Flutter温泉</a>に行ったり、今年の後半はFlutter三昧でした。</p>

<p>そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。</p>

<p>開発環境は下記のとおりです。</p>

<pre><code>% flutter doctor
Doctor summary (to see all details, run flutter doctor -v):
[✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP)
[✓] Android toolchain - develop for Android devices (Android SDK 28.0.3)
[✓] iOS toolchain - develop for iOS devices (Xcode 10.1)
[✓] Android Studio (version 3.2)
[✓] VS Code (version 1.29.1)
[✓] Connected device (2 available)
</code></pre>

<h1 id="まずどんな機能を作ったか">まずどんな機能を作ったか？</h1>

<p>大きく分けると次のようになるかなと思います。</p>

<ul>
<li>会員登録・ログイン</li>
<li>チャットルーム（以下、ルーム）作成できる</li>
<li>ルーム一覧を見ることができる</li>
<li>ルームでチャット(テキスト、画像の送信)ができる</li>
<li>既存のルームにユーザーが参加できる</li>
<li>自分のプロフィールを見ることができる</li>
<li>アプリ内課金で定期購読できる</li>
</ul>

<p>それぞれ見ていきます。</p>

<h2 id="会員登録-ログイン">会員登録・ログイン</h2>

<p>チャットアプリなので、だれが投稿したか知りたいので、会員登録・ログインをできるようにしました。
これは、<a href="https://pub.dartlang.org/packages/firebase_auth">firebase_auth</a>プラグインを使っていて、現在はGoogleログインと、Facebookログインに対応しています。</p>

<p>まずこんな感じで表示されるGoogleログインボタンのUIの実装を見てみます。</p>

<p><img width="400" src="https://qiita-image-store.s3.amazonaws.com/0/22161/78e8c0fa-8cc5-1f77-be7e-5a0552a08cf9.png" /></p>

<p>signInButtonというWidgetを作成し、</p>

<pre><code class="language-signin_button.dart">import 'package:flutter/material.dart';

Widget signInButton(title, uri,
    [color = const Color.fromRGBO(68, 68, 76, .8)]) {
  return Container(
    padding: const EdgeInsets.all(16.0),
    child: Center(
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: &lt;Widget&gt;[
          Image.asset(
            uri,
            width: 25.0,
          ),
          Padding(
            child: Text(
              title,
              style: TextStyle(
                fontFamily: 'Roboto',
                color: color,
              ),
            ),
            padding: EdgeInsets.only(left: 15.0),
          ),
        ],
      ),
    ),
  );
}
</code></pre>

<p>使う側は例えば次のように使います。</p>

<pre><code class="language-dart">MaterialButton(
  child: signInButton(Strings.of(context).signInWithGoogle,
      'assets/images/google.png'),
  onPressed: _isAgree ? _handleSignInWithGoogle : _showError,
  color: Colors.white,
),
````


ログインとは直接関係ないですが`_isAgree`はプライバシーポリシーと利用規約に同意したかどうかで、同意していれば`_handleSignInWithGoogle`を呼び、同意してなければエラーにしています。

また、`Strings.of(context).signInWithGoogle`の部分は多言語対応していて、Android のstringsリソースをイメージしています([こちら](https://qiita.com/jiro-aqua/items/fd9896682ca09018fdd3)が参考になりました)。

ボタンができたので、Googleログインの処理は次のような感じにしています。

`_googleSignIn`を準備して、

```dart
final GoogleSignIn _googleSignIn = GoogleSignIn(
    scopes: &lt;String&gt;['email'],
);
</code></pre>

<p>ログインボタンが押されたタイミングで、下記のようにします。</p>

<pre><code class="language-dart">Future&lt;FirebaseUser&gt; signInWithGoogle() async {
  GoogleSignInAccount googleUser = await _googleSignIn.signIn();
  if (googleUser == null) {
    return null;
  }
  GoogleSignInAuthentication googleAuth = await googleUser.authentication;
  final AuthCredential credential = GoogleAuthProvider.getCredential(
    accessToken: googleAuth.accessToken,
    idToken: googleAuth.idToken,
  );
  FirebaseUser user = (await _auth.signInWithCredential(credential)).user;
  return user;
}
</code></pre>

<p>プラグインが<a href="https://docs.flutter.io/flutter/services/PlatformException-class.html"><code>PlatformException</code></a>を投げることがあるので、try catchして、PlatformExceptionにキャストすると<a href="https://docs.flutter.io/flutter/services/PlatformException/code.html"><code>code</code></a>が取得できるので、それでエラー判定するとよいかと思います。ただし、プラグインによっては、違うエラーだけど<code>code</code>が全部一緒だったり、iOSとAndroidで<code>code</code>が異なっていたりする場合があるので、プラグインによって対応を変えなければいけないことがあります。</p>

<pre><code class="language-dart">try {
  // ↑のsignIn処理のため省略
} catch (error) {
  if (error is PlatformException) {
    switch (error.code) {
      case GoogleSignIn.kSignInFailedError:
        // something
      case GoogleSignIn.kSignInCanceledError:
        // something
      case GoogleSignIn.kSignInRequiredError:
        // something
      case GoogleSignInAccount.kFailedToRecoverAuthError:
        // something
      case GoogleSignInAccount.kUserRecoverableAuthError:
        // something
      default:
        // something
    }
  }
  return null;
}
</code></pre>

<p>あと、<a href="https://pub.dartlang.org/packages/flutter_firebase_ui">flutter_firebase_ui</a>を使うと少しだけ楽に作れますが、ボタンを押したイベントが取れずプログレスを出すことができないため、それぞれ<a href="https://pub.dartlang.org/packages/google_sign_in">google_sign_in</a>と<a href="https://pub.dartlang.org/packages/flutter_facebook_login">flutter_facebook_login</a>をそれぞれ使っています。</p>

<h2 id="ルーム作成機能">ルーム作成機能</h2>

<p>ルームを作成するのに、下図のようにルーム画像とルーム名を入力してもらうようにしました。</p>

<p><img width="400" src="https://qiita-image-store.s3.amazonaws.com/0/22161/f8a45a66-d7e6-f575-8667-f3beccedd880.png" /></p>

<p>黄色の円をタップすると画像を選択するようにし、TextFieldにはルーム名を入力できます。</p>

<p>これをコードで見ると次のようにしています。</p>

<pre><code class="language-dart">Widget roomImageWidget = GestureDetector(
  child: Stack(
    alignment: const Alignment(0.6, 0.6),
    children: [
      ImageUtils.circleImageProvider(_previewImage(_imageFile),
          radius: 100.0, text: _inputtingRoomName),
      Icon(Icons.camera_alt),
    ],
  ),
  onTap: () =&gt; _onTapRoomImage(context),
);
</code></pre>

<p>円のWidgetとカメラアイコンのWidgetを重ねていますが、このように2つ以上のWidgetを重ねるには、<code>Stack</code>(<a href="https://flutter.io/docs/development/ui/layout#stack">こちら</a>が参考になるかと思います)を使います。
また、全体をタップできるようにしたいため、Stackを<a href="https://docs.flutter.io/flutter/widgets/GestureDetector-class.html"><code>GestureDetector</code></a>でWrapしています。</p>

<p>画像を円形に表示するには、circleImageProviderの自作メソッドの中でやっているのですが、次のように<a href="https://docs.flutter.io/flutter/material/CircleAvatar-class.html"><code>CircleAvatar</code></a>を使うと便利かと思います。</p>

<pre><code class="language-dart">CircleAvatar(
  child: child,
  backgroundColor: Colors.yellow,
  backgroundImage: imageProvider,
  radius: radius,
);
</code></pre>

<h3 id="bottomsheetを使って選択">BottomSheetを使って選択</h3>

<p>ルーム画像を設定するために先程の黄色の画像をタップすると、「ギャラリー」か「カメラ」をBtoomSheetを使って選択できるようにしています。<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup></p>

<p><img width="400" src="https://qiita-image-store.s3.amazonaws.com/0/22161/976166ab-c3f9-f626-2dc9-666eae82296d.png" /></p>

<p>これを実装するには、次のように<a href="https://docs.flutter.io/flutter/material/showModalBottomSheet.html"><code>showModalBottomSheet</code></a>(<a href="https://flutterdoc.com/bottom-sheets-in-flutter-ec05c90453e7">こちら</a>が参考になるかと思います)を使います。</p>

<pre><code class="language-dart">Future&lt;void&gt; showCameraSelector(BuildContext context,
        VoidCallback onTapGallery, VoidCallback onTapCamera) =&gt;
    showModalBottomSheet&lt;void&gt;(
        context: context,
        builder: (BuildContext context) =&gt; Column(
              mainAxisSize: MainAxisSize.min,
              children: &lt;Widget&gt;[
                ListTile(
                  leading: Icon(Icons.photo_library),
                  title: Text(Strings.of(context).gallery),
                  onTap: onTapGallery,
                ),
                ListTile(
                  leading: Icon(Icons.camera_alt),
                  title: Text(Strings.of(context).camera),
                  onTap: onTapCamera,
                ),
              ],
            ));
</code></pre>

<p><code>onTapGallery</code>や<code>onTapCamera</code>では、好みの写真プラグインを使えばよいかと思います。今回は<a href="https://pub.dartlang.org/packages/image_picker">image_picker</a>を使いました。</p>

<h3 id="画像の圧縮">画像の圧縮</h3>

<p>画像のアップロード前に圧縮しているのですが、プラグインを調べると最初に目についたのが<a href="https://pub.dartlang.org/packages/image">Image</a>プラグインだったのでこちらを使っていました。が、Image.decodeが4,5分かかって使い物にならないので、<a href="https://github.com/btastic/flutter_native_image">flutter_native_image</a>を使っています。こちらはだいたい100ms以内で終わってくれるので早いです！</p>

<p>実装例は次のとおりです。</p>

<pre><code class="language-image.dart">import 'dart:io';

import 'package:flutter_native_image/flutter_native_image.dart';

class Image {
  /// 画像を圧縮する
  /// https://stackoverflow.com/a/50998865
  /// ↓に変更
  /// https://github.com/flutter/flutter/issues/19383#issuecomment-405130684
  /// https://github.com/btastic/flutter_native_image
  /// @param file オリジナルファイル
  /// @return 圧縮されたfile
  static Future&lt;File&gt; compress(File file) async {
    ImageProperties properties =
        await FlutterNativeImage.getImageProperties(file.path);
    return await FlutterNativeImage.compressImage(file.path,
        quality: 80,
        targetWidth: 600,
        targetHeight: (properties.height * 600 / properties.width).round());
  }
}
</code></pre>

<h3 id="画像のアップロード">画像のアップロード</h3>

<p>画像のアップロード先はCloud Storageにしていますので、<a href="https://pub.dartlang.org/packages/firebase_storage">firebase_storage</a>プラグインを使用しています。
画像をアップロードして、アップロード先のURLを知りたいのでコードは次のようにしています。</p>

<pre><code class="language-dart">Future&lt;String&gt; uploadImage(File file) async {
  int timestamp = DateTime.now().millisecondsSinceEpoch;
  String subDirectoryName = 'images';
  final StorageReference ref = storage
      .ref()
      .child(subDirectoryName)
      .child('${timestamp}');
  final StorageUploadTask uploadTask = ref.putFile(
      file,
      StorageMetadata(
        contentType: &quot;image/jpeg&quot;,
      ));
  StorageTaskSnapshot snapshot = await uploadTask.onComplete;
  if (snapshot.error == null) {
    return await snapshot.ref.getDownloadURL();
  }
  switch (snapshot.error) {
    case StorageError.unknown:
      // something
    case StorageError.objectNotFound:
      // something
    case StorageError.bucketNotFound:
      // something
    case StorageError.projectNotFound:
      // something
    case StorageError.quotaExceeded:
      // something
    case StorageError.notAuthenticated:
      // something
    case StorageError.notAuthorized:
      // something
    case StorageError.retryLimitExceeded:
      // something
    case StorageError.invalidChecksum:
      // something
    case StorageError.canceled:
      // something
  }
  return null;
}
</code></pre>

<p>画像のアップロードはルーム作成時だけでなく、チャットのメッセージとしてアップロードできるようにしていますし、プロフィール画像を変更できるようにもしているので、実際のコードはアップロード先を変更する処理とか入ったり、戻りの型が違ったりしてますが、だいたいこのような感じです。<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup></p>

<h3 id="firestoreに格納する">Firestoreに格納する</h3>

<p>ルームを保存する場所はCloud Firestoreを使っていますので、<a href="https://pub.dartlang.org/packages/cloud_firestore">cloud_firestore</a>プラグインを使います。</p>

<pre><code class="language-dart">Future&lt;void&gt; createNewRoom(Room room) async {
  return _firestore
      .collection('rooms')
      .document(room.id)
      .setData(&lt;String, dynamic&gt;{'id': room.id, 'name': room.name});
}
</code></pre>

<h2 id="ルーム一覧">ルーム一覧</h2>

<p>ルーム一覧画面でfirestoreのroomsコレクションを監視していて、roomsコレクションにドキュメントが変更されたら更新されるようにしています。</p>

<pre><code class="language-dart">_firestore
    .collection('rooms')
    .where(/** 条件 */) 
    .snapshots()
    .listen((querySnapshot) async {
        // 'rooms'に変化があったら通知される
    });
</code></pre>

<h2 id="ルームでチャット-テキスト-画像の送信-ができる">ルームでチャット(テキスト、画像の送信)ができる</h2>

<p>ルームのイメージです。</p>

<p><img width="300" alt="room.png" src="https://qiita-image-store.s3.amazonaws.com/0/22161/1b817812-d68e-8d5b-53b3-7daf65e5bc1a.png"></p>

<p>詳細を書くとここだけで1記事になりそうなのであまり細かくは書きませんが、簡単に。</p>

<h3 id="チャットメッセージの表示部分">チャットメッセージの表示部分</h3>

<p>チャットメッセージの表示部分はListを逆順で表示しています。これは<code>ListView.builder</code>の<code>reverse</code>を<code>true</code>にすることで逆順にできます。</p>

<pre><code class="language-dart">Widget _buildListView() =&gt; ListView.builder(
      controller: _scrollController,
      reverse: true,
      itemCount: messages != null ? messages.length : 0,
      itemBuilder: (BuildContext context, int position) =&gt;
          _buildMessageRow(context, position),
    );
</code></pre>

<h3 id="画像を横幅いっぱいかつ角丸">画像を横幅いっぱいかつ角丸</h3>

<pre><code class="language-dart">Widget _buildImageWidget(
    BuildContext context, Message message, int position) {
  return SizedBox(
      height: 180.0,
      child: Container(
          padding: EdgeInsets.only(top: 8.0, right: 8.0, bottom: 8.0),
          child: GestureDetector(
            onTap: () {
              _onTapImage(position);
            },
            child: message.downloadImageUrl != null
                ? ImageUtils.roundedImage(message.downloadImageUrl.toString())
                : Text(Strings.of(context).uploading),
          )));
}
</code></pre>

<p>ImageUtils.roundedImageの部分は以下です。</p>

<pre><code class="language-dart">static Widget roundedImage(String imageUrl) {
  return ClipRRect(
      borderRadius: BorderRadius.circular(8.0),
      child: cachedImage(imageUrl, fit: BoxFit.cover));
}
</code></pre>

<h3 id="画像のキャッシュ">画像のキャッシュ</h3>

<p>画像のキャッシュには<a href="https://pub.dartlang.org/packages/cached_network_image">cached_network_image</a>プラグインを使用しています。</p>

<pre><code class="language-dart">static CachedNetworkImage cachedImage(String imageUrl, {fit}) {
  return CachedNetworkImage(
    imageUrl: imageUrl,
    errorWidget: Icon(Icons.error),
    fit: fit,
  );
}
</code></pre>

<h3 id="メッセージ入力部分">メッセージ入力部分</h3>

<h4 id="送信タイミングでテキストをクリアするには">送信タイミングでテキストをクリアするには</h4>

<p>送信ボタンを押すタイミングで入力テキストをクリアしたいと思ったとき、次のような実装がパッと思いつくかと思います。</p>

<pre><code class="language-dart">_texEditingController.crear();
</code></pre>

<p>これだと日本語などの文字を入力中（確定前）に、クリアするとクラッシュしてしまいます。仕様など見たりいろいろ調べたところ、次のようにするとクラッシュしなくなりました。</p>

<pre><code class="language-dart">_texEditingController
  ..clearComposing()
  ..clear();
</code></pre>

<h4 id="キーボードを閉じるには">キーボードを閉じるには</h4>

<p>TextField部分をタップするとキーボードが表示されますが、iOSの場合はなにもしないとキーボードを閉じることができません。たとえば、チャットメッセージの表示部分をタップしてキーボードを閉じるには、チャットメッセージリスト部分を<code>GestureDetector</code>でWrapして、onTapでフォーカスを変えることで閉じることができます。</p>

<pre><code class="language-dart">GestureDetector(
    onTap: () =&gt; FocusScope.of(context).requestFocus(FocusNode()),
    child: _buildListView(),
)
</code></pre>

<p>focusまわりは<a href="https://flutter.io/docs/cookbook/forms/focus">こちら</a>が参考になるかと思います。</p>

<h2 id="既存のルームにユーザーが参加できる">既存のルームにユーザーが参加できる</h2>

<p>既存のルームに他のユーザーが参加するためには、そのルームのQRコードを読み取って参加します。</p>

<h3 id="qrコードを生成するには">QRコードを生成するには</h3>

<p>ルームから下図のような画面を出して読み取ってもらうことにしました。</p>

<p><img width="300" alt="room.png" src="https://qiita-image-store.s3.amazonaws.com/0/22161/3202190c-70f9-9581-764b-9d8624fa7ef0.png"></p>

<p>QRコード生成には<a href="https://pub.dartlang.org/packages/qr_flutter">qr_flutter</a>プラグインを使用していて、この画面の全体のコードは下記のように実装しました。</p>

<pre><code class="language-dart">/// QRコードを表示するための画面
class DisplayQrCodeScreen extends StatelessWidget implements Screen {
  final String _qrCodeData;

  const DisplayQrCodeScreen(this._qrCodeData);

  @override
  Widget build(BuildContext context) {
    final bodyHeight = MediaQuery.of(context).size.height -
        MediaQuery.of(context).viewInsets.bottom;

    return Scaffold(
      appBar: AppBar(
        title: Text(Strings.of(context).qrCode),
        backgroundColor: Colors.black,
      ),
      backgroundColor: Colors.black,
      body: Container(
        color: Colors.white,
        child: Center(
          child: QrImage(
            version: 10,
            data: _qrCodeData,
            size: 0.2 * bodyHeight,
          ),
        ),
      ),
    );
  }

  @override
  String get name =&gt; &quot;/qr&quot;;
}
</code></pre>

<p>QRコードのサイズを画面の高さの20%になるように設定しました。デバイス画面サイズを取得するために、<a href="https://docs.flutter.io/flutter/widgets/MediaQuery-class.html">MediaQuery</a>を使っています。</p>

<h3 id="qrコード読み取り">QRコード読み取り</h3>

<p>QRコードの表示ができたので、今度は読み取りです。本アプリでルームに参加するためには、ルームを表すQRコードを読み取る必要があります。QR読み取る方法として2種類用意しました。</p>

<p><img width="300"  src="https://qiita-image-store.s3.amazonaws.com/0/22161/e47a79ea-79f1-6379-c47f-c206b5776db6.png"></p>

<ul>
<li>QRコードをカメラで読み取る</li>
<li>QRコード画像を開いて読み取る</li>
</ul>

<p>の2種類です。</p>

<h4 id="qrコードをカメラで読み取る">QRコードをカメラで読み取る</h4>

<p>使用しているプラグインは<a href="https://pub.dartlang.org/packages/barcode_scan">barcode_scan</a>です。（QRコードリーダーに関して、以前<a href="https://kwmt27.net/2018/08/16/flutter-workshop/">ブログを書きました</a>のでご興味あればぜひ！)</p>

<pre><code class="language-dart">/// カメラを使ってQRコードをスキャンしてRoomに参加する
void _joinRoomWithCamera(BuildContext context) async {
  try {
    _roomId = await BarcodeScanner.scan();
  } catch (error) {
    if (error is PlatformException &amp;&amp;
        error.code == BarcodeScanner.CameraAccessDenied) {
       // something
    }
  }
}
</code></pre>

<p>ポイントは<code>BarcodeScanner.scan()</code>だけでQRコード読み取り画面を呼び出せます。カメラアクセス許可されてない場合にエラーコードが<code>BarcodeScanner.CameraAccessDenied</code>で来るので、メッセージを出すとかするとよいかと思います。</p>

<h4 id="qrコード画像を開いて読み取る">QRコード画像を開いて読み取る</h4>

<p>こちらは最近実装したのですが、<a href="https://pub.dartlang.org/packages/firebase_ml_vision">firebase_ml_vision</a>プラグインを使って実現しました。学習モデルをダウンロードするためアプリ容量が増えてしまうのが難点なのですが(20MBぐらい増えました)。</p>

<p><a href="https://pub.dartlang.org/packages/image_picker">image_picker</a>プラグインでギャラリーからQRコード画像を開けるようにしておき、選択した画像をMLKitのBarcodeDetectorを使って検出しするという流れです。</p>

<pre><code class="language-dart">Future&lt;void&gt; _onImageButtonPressed(ImageSource source) async {
  File selectedImageFile = await ImagePicker.pickImage(source: source);
  if (selectedImageFile == null) {
    return;
  }
  FirebaseVisionImage visionImage =
      FirebaseVisionImage.fromFile(selectedImageFile);
    final BarcodeDetectorOptions options = BarcodeDetectorOptions()
  final BarcodeDetector barcodeDetector =
      FirebaseVision.instance.barcodeDetector();
  final List&lt;Barcode&gt; barcodes =
      await barcodeDetector.detectInImage(visionImage);
  for (Barcode barcode in barcodes) {
    final BarcodeValueType valueType = barcode.valueType;
    switch (valueType) {
      case BarcodeValueType.text:
        final String value = barcode.displayValue;
        _roomId = value;
        break;
      default:
        break;
    }
  }
}
</code></pre>

<p>実装としてはこれで可能ですが、Androidでアプリ起動時に次のような例外が出るようになってしまいました。</p>

<pre><code>2-06 17:02:11.288  9895  9895 E AndroidRuntime: java.lang.UnsatisfiedLinkError: dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/system/framework/org.apache.http.legacy.boot.jar&quot;, zip file &quot;/data/app/com.instantonnection.app-zIN5KpTkwZQRngy5QLP6ig==/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.instantonnection.app-zIN5KpTkwZQRngy5QLP6ig==/lib/arm64, /data/app/com.instantonnection.app-zIN5KpTkwZQRngy5QLP6ig==/base.apk!/lib/arm64-v8a, /system/lib64]]] couldn't find &quot;libflutter.so&quot;
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at java.lang.Runtime.loadLibrary0(Runtime.java:1012)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at java.lang.System.loadLibrary(System.java:1669)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at io.flutter.view.FlutterMain.startInitialization(Unknown Source:32)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at io.flutter.view.FlutterMain.startInitialization(Unknown Source:5)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at io.flutter.app.FlutterApplication.onCreate(Unknown Source:3)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.Instrumentation.callApplicationOnCreate(Instrumentation.java:1154)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread.handleBindApplication(ActivityThread.java:5871)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread.access$1100(ActivityThread.java:199)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1650)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.os.Handler.dispatchMessage(Handler.java:106)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.os.Looper.loop(Looper.java:193)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread.main(ActivityThread.java:6669)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at java.lang.reflect.Method.invoke(Native Method)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)
</code></pre>

<p>この対策としては、</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/22161/cb38beed-5f59-91ed-05d6-21ae768fb6ec.png" alt="image.png" /></p>

<p>と設定し、ビルド時に以下のオプションをつけることで解決しました。(<a href="https://github.com/azihsoyn/flutter_mlkit/issues/36#issuecomment-421541533">参考</a>)</p>

<pre><code>--target-platform android-arm
</code></pre>

<h2 id="自分のプロフィールを見ることができる">自分のプロフィールを見ることができる</h2>

<p>下のように、スクロールするとヘッダーが変化するWidgetを使っています。<sup class="footnote-ref" id="fnref:3"><a href="#fn:3">3</a></sup></p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/22161/2ef503df-0dcc-605e-d653-bfc95a2b778c.gif" alt="profile.gif" /></p>

<p>コードはこんな感じです。</p>

<pre><code class="language-dart">Widget screen = Scaffold(
  body: CustomScrollView(slivers: &lt;Widget&gt;[
    SliverAppBar(
      expandedHeight: _appBarHeight,
      pinned: true,
      elevation: 4.0,
      actions: actions,
      flexibleSpace: FlexibleSpaceBar(
        title: Text(widget.user.name),
        background: Stack(
          fit: StackFit.expand,
          children: &lt;Widget&gt;[
            ImageUtils.cachedImage(widget.user.photoUrl.toString(),
                fit: BoxFit.cover),
            // This gradient ensures that the toolbar icons are distinct
            // against the background image.
            const DecoratedBox(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment(0.0, -1.0),
                  end: Alignment(0.0, -0.4),
                  colors: &lt;Color&gt;[Color(0x60000000), Color(0x00000000)],
                ),
              ),
            ),
          ],
        ),
      ),
    ),
    SliverList(
        delegate: SliverChildListDelegate(&lt;Widget&gt;[
      AnnotatedRegion&lt;SystemUiOverlayStyle&gt;(
          value: SystemUiOverlayStyle.dark, child: body),
    ]))
  ]),
);
</code></pre>

<p><a href="https://www.youtube.com/watch?v=R9C5KMJKluE&amp;vl=en">こちらの動画</a>で雰囲気つかめるかと思います。</p>

<h2 id="アプリ内課金で定期購読できる">アプリ内課金で定期購読できる</h2>

<p>このアプリの目玉とも言える（笑）アプリ内課金を実装しました。使用したプラグインは<a href="https://pub.dartlang.org/packages/flutter_inapp_purchase">flutter_inapp_purchase</a>です。</p>

<p><img width="375" src="https://qiita-image-store.s3.amazonaws.com/0/22161/340c8a58-ad25-d263-747c-99763c539014.png"></p>

<p>このプラグインの使い方は<a href="https://pub.dartlang.org/packages/flutter_inapp_purchase#-readme-tab-">README</a>を見てもらうとわかるのですが、このプラグインから投げられる例外が微妙で、エラー処理がちょっと大変でした。</p>

<p>たとえば、下図はいったん購入しようとしたけどキャンセルした場合の例ですが、PlatformExceptionが投げれるのは良いのですが、<a href="https://github.com/dooboolab/flutter_inapp_purchase/blob/a249e5fe7563a958c19484db7988362cad3bcb1e/android/src/main/java/com/dooboolab/flutterinapppurchase/AndroidInappPurchasePlugin.java#L432">codeがTAG</a>になっていて、どの例外もcodeで判断できません。
<img src="https://qiita-image-store.s3.amazonaws.com/0/22161/5f697635-f2c2-b1b4-70ee-8d431e50b970.png" alt="image.png" /></p>

<p>よく見るとdetailsの「responseCode: 1」の<a href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient.BillingResponse.html#USER_CANCELED">1がCancelを表すエラーコード</a>になっていますので、それで判断するしか無さそうです。</p>

<p>先程のはAndroidでしたが、同じキャンセルでもiOSでキャンセルすると違うcodeが返ってきます。。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/22161/2235b4d3-caa5-1613-4a06-718232a87857.png" alt="image.png" /></p>

<p>なので、アプリのコードとしては以下のようにしました。</p>

<pre><code class="language-dart">Future&lt;MyPurchaseItem.PurchasedItem&gt; buySubscription(String productId) =&gt;
    FlutterInappPurchase.buySubscription(productId)
        .then((item) =&gt; _purchasedTranslator
            .toModel(_translateToPurchasedItemEntity(item)))
        .catchError((error) {
      // エラーコード統一してほしい・・・
      if (Platform.isAndroid) {
        if (error.code == &quot;InappPurchasePlugin&quot; &amp;&amp; error.details is String) {
          // https://developer.android.com/reference/com/android/billingclient/ap
          String details = error.details as String;
          String USER_CANCELED = &quot;1&quot;;
          if (details.endsWith(USER_CANCELED)) {
            return;
          }
        }
      } else if (Platform.isIOS) {
        // https://github.com/dooboolab/flutter_inapp_purchase/blob/a249e5fe7563a
        if (error.code == &quot;E_USER_CANCELLED&quot;) {
          return;
        }
      }
      throw error;
    });
</code></pre>

<p>このプラグインが使えないとか言いたいわけではなくて、自分がプラグインを作るときは以下の点に気をつけたいなぁと思いました。</p>

<ul>
<li>error codeは適切なコードにする</li>
<li>error codeはiOS、Androidで統一する</li>
<li>アプリケーション側でエラーコードを変数で扱えるようにする

<ul>
<li>たとえば<a href="https://github.com/flutter/plugins/blob/master/packages/firebase_storage/lib/src/error.dart">こんなイメージ</a>です。</li>
</ul></li>
</ul>

<p>あ、アプリ内課金そのものについて触れてませんでしたね。。とはいえ、Flutterというよりそれぞれのプラットフォームの話なので詳細には触れませんが、参考リンクだけ張っておきます。</p>

<ul>
<li><a href="https://ameblo.jp/principia-ca/entry-12071725733.html">自動購読課金について【Android編】</a></li>
<li><a href="https://ameblo.jp/principia-ca/entry-12071724382.html?frm=theme">自動購読課金について【iOS編】</a></li>
<li><a href="https://developer.apple.com/jp/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Chapters/Subscriptions.html">In-App Purchaseプログラミングガイド</a></li>
<li><a href="https://developer.android.com/google/play/billing/api">In-app Billing API</a></li>
<li><a href="https://github.com/awa/go-iap">go-iap</a><sup class="footnote-ref" id="fnref:4"><a href="#fn:4">4</a></sup></li>
</ul>

<h1 id="その他-細かいけど必要な機能">その他 細かいけど必要な機能</h1>

<p>細かいけど必要だったり便利な機能を見ていきたいと思います。</p>

<ul>
<li>メッセージを送信したら通知が届く</li>
<li>メッセージ入力中に画面を戻ってしまったなどのメッセージが消えないようにする</li>
<li>チャットメッセージにURLがあるとタップできてリンクを開くことができる</li>
<li>チャットメッセージの画像を拡大できる</li>
<li>チャットメッセージの画像を横スワイプで切り替えることができる</li>
<li>チャットメッセージの画像を上下スワイプで閉じることができる</li>
<li>開発者のための機能

<ul>
<li>analytics</li>
<li>crashlytics</li>
<li>AdMob</li>
</ul></li>
<li>リリースまでに必要なの

<ul>
<li>ランチャーアイコン</li>
<li>スクリーンショット</li>
</ul></li>
</ul>

<h2 id="メッセージを送信したら通知が届く">メッセージを送信したら通知が届く</h2>

<p><a href="https://pub.dartlang.org/packages/firebase_messaging">firebase_messaging</a>プラグインを使って、roomIdとuserIdをトピックに登録しています。</p>

<p>subscribe,unsubscribeは簡単です。</p>

<pre><code class="language-dart">FirebaseMessaging _firebaseMessaging = FirebaseMessaging();
_firebaseMessaging.subscribeToTopic(topic);
_firebaseMessaging.unsubscribeFromTopic(topic);
</code></pre>

<p>Cloud Functionsがfirestoreのメッセージコレクションを監視して、追加があったらCloud Functionsがプッシュを投げるようにしています。(Cloud FunctionsのFCMの<a href="https://github.com/firebase/functions-samples/tree/Node-8/fcm-notifications">サンプル</a>が参考になるかと思います)</p>

<h2 id="メッセージ入力中に画面を戻ってしまったなどのメッセージが消えないようにする">メッセージ入力中に画面を戻ってしまったなどのメッセージが消えないようにする</h2>

<p>長文を書いてて間違って戻ってしまった場合、長文のメッセージが消えてしまったとかはいやなので、<a href="https://pub.dartlang.org/packages/shared_preferences">shared_preferences</a>プラグインを使って<code>dispose</code>のタイミングでローカルストレージに保存しています。</p>

<pre><code class="language-dart">Future&lt;bool&gt; saveMessage(Message message, String roomId) async {
  SharedPreferences prefs = await SharedPreferences.getInstance();
  return prefs.setString(
      _createMessageKey(roomId), message.content);
}

String _createMessageKey(String roomId) =&gt;
    &quot;${SharedPreferenceType.message.toString()}/$roomId&quot;;
</code></pre>

<p>画面に戻ってきたときは、<code>initState</code>のタイミングで保存したメッセージを読み込んでTextFieldにセットしています。</p>

<pre><code class="language-dart">Future&lt;String&gt; getMessage(String roomId) async {
  SharedPreferences prefs = await SharedPreferences.getInstance();
  return prefs.getString(_createMessageKey(roomId));
}
</code></pre>

<pre><code class="language-dart">getMessage(widget.room.id).then((message) {
  setState(() {
    _texEditingController.text = message;
  });
});
</code></pre>

<h2 id="チャットメッセージにurlがあるとタップしてリンクを開くことができる">チャットメッセージにURLがあるとタップしてリンクを開くことができる</h2>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/22161/37b4116e-14fc-da30-e43a-d43acf8bc124.gif" alt="link.gif" /></p>

<p>あんまりスマートではないのですが、実装例です。</p>

<pre><code class="language-dart">class Message {
  String id;
  String content;

  List&lt;LinkText&gt; get linkTextList {
    if (content == null) {
      return null;
    }

    List&lt;LinkText&gt; results = List();
    // https://stackoverflow.com/a/6041965
    RegExp exp = RegExp(
        r'(http|https)://([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&amp;:/~+#-]*[\w@?^=%&amp;/~+#-])?');

    String _content = content;

    do {
      if (_content.length == 0) {
        return results;
      }

      Match match = exp.firstMatch(_content);
      if (match == null) {
        results.add(LinkText(_content));
        return results;
      }

      // urlが見つかるまでにテキストがあれば追加する
      String str = _content.substring(0, match.start);
      if (str.length &gt; 0) {
        results.add(LinkText(str));
      }
      String url = match.group(0);
      results.add(LinkText(url, url: url));
      _content = _content.substring(match.end, _content.length);
    } while (_content.length &gt; 0);
    return results;
  }

  Message(this.id, this.content);
}

class LinkText {
  String text;
  String url;

  LinkText(this.text, {this.url});
}
</code></pre>

<p>Messageクラスのcontentに入力したメッセージが入る想定で、Widget側で次のように使っています。</p>

<pre><code class="language-dart">Widget _buildMessageWidget(BuildContext context, Message message) {
  final TextStyle aboutTextStyle = Theme.of(context).textTheme.body2;
  List&lt;TextSpan&gt; children = message.linkTextList.map((linkText) {
    // textがnullではなくurlがnullならリンクにしない。
    // textもurlもnullではない場合、urlに遷移するリンクにする。
    if (linkText.url == null) {
      return TextSpan(style: aboutTextStyle, text: linkText.text);
    }
    return LinkTextSpan(
        context: context, text: linkText.text, url: linkText.url);
  }).toList();
  return Container(
    child: RichText(
      text: TextSpan(
        style: TextStyle(fontSize: 16.0),
        children: children,
      ),
    ),
  );
}
</code></pre>

<p>LinkTextSpanクラスは次のとおりです。</p>

<pre><code class="language-dart">import 'package:flutter/gestures.dart';
import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';

// https://github.com/flutter/flutter/blob/master/examples/flutter_gallery/lib/gallery/about.dart#L11-L33
class LinkTextSpan extends TextSpan {
  LinkTextSpan(
      {BuildContext context,
      TextStyle style,
      String url,
      String text,
      bool inAppWebView = false})
      : super(
            style: style ?? url != null
                ? TextStyle(
                    color: Colors.blue,
                    decoration: TextDecoration.underline,
                  )
                : Theme.of(context).textTheme.body2,
            text: text ?? url,
            recognizer: TapGestureRecognizer()
              ..onTap = () {
                launch(url, forceWebView: inAppWebView);
              });
}
</code></pre>

<p><code>launch</code>は<a href="https://pub.dartlang.org/packages/url_launcher">url_launcher</a>プラグインで、URLを開くことができます。</p>

<h2 id="チャットメッセージの画像を拡大できる">チャットメッセージの画像を拡大できる</h2>

<p>画像の拡大には<a href="https://pub.dartlang.org/packages/photo_view">photo_view</a>プラグインを使っています。</p>

<pre><code class="language-dart">Container(
  child: Center(
    child: PhotoView(
      imageProvider: NetworkImage(imageUrl),
      minScale: PhotoViewComputedScale.contained * 1.0,
      maxScale: 2.0,
    ),
  ),
);
</code></pre>

<h2 id="チャットメッセージの画像を横スワイプで切り替えることができる">チャットメッセージの画像を横スワイプで切り替えることができる</h2>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/22161/30e120ef-cde9-d9fb-8371-86b7ea1e59eb.gif" alt="swipe.gif" /></p>

<p>画像を横スワイプで切り替えるのに、<a href="https://docs.flutter.io/flutter/material/DefaultTabController-class.html">DefaultTabController</a>と<a href="https://docs.flutter.io/flutter/material/TabBarView-class.html">TabBarView</a>クラスを組み合わせて使っています。</p>

<p>全体のコードはこちらの<a href="https://gist.github.com/kwmt/ba4701b2b80b3675e7c58ea9b841f45f">gist</a>を見ていただければと思いますが、雰囲気は下記のような感じです。</p>

<pre><code class="language-dart">DefaultTabController(
      initialIndex: position,
      length: imageUrls.length,
      child: _PageSelector(imageUrls: imageUrls, position: position),
    );
</code></pre>

<p><code>_PageSelector</code>はStatelessWidgetになっていて、下記を実装しています。</p>

<pre><code class="language-dart">child: TabBarView(
    children: imageUrls.map((String imageUrl) {
  return Container(
    child: Center(
      child: PhotoView(
        imageProvider: NetworkImage(imageUrl),
        minScale: PhotoViewComputedScale.contained * 1.0,
        maxScale: 2.0,
      ),
    ),
  );
}).toList()),
</code></pre>

<h2 id="チャットメッセージの画像を上下スワイプで閉じることができる">チャットメッセージの画像を上下スワイプで閉じることができる</h2>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/22161/abf30870-8ecf-e758-bcfe-736ec74e1d96.gif" alt="dismissable.gif" /></p>

<p>画面全体のWidget(ここではScaffold)を<a href="https://docs.flutter.io/flutter/widgets/Dismissible-class.html"><code>Dismissable</code></a>でWrapするだけです。<sup class="footnote-ref" id="fnref:5"><a href="#fn:5">5</a></sup></p>

<pre><code class="language-dart"> Dismissible(
  key: key,
  direction: DismissDirection.vertical,
  onDismissed: (direction) {
    Navigator.pop(context);
  },
  child: Scaffold(appBar: AppBar(省略...
);
</code></pre>

<h2 id="開発者のための機能">開発者のための機能</h2>

<h3 id="analytics">analytics</h3>

<p>GoogleAnalyticsも<a href="https://pub.dartlang.org/packages/firebase_analytics">firebase_analytics</a>プラグインがあって、スクリーン名やイベントを取ることができます。</p>

<p><img height="300" src="https://qiita-image-store.s3.amazonaws.com/0/22161/672aab2e-1280-0297-30c9-6d3d607f54f9.png"></p>

<p><img width="300" src="https://qiita-image-store.s3.amazonaws.com/0/22161/7d28f14b-5d89-3895-ef55-6777e9ebae78.png"></p>

<h3 id="crashlytics">crashlytics</h3>

<p>crashlyticsはGoogle公式ではありませんが、<a href="https://pub.dartlang.org/packages/flutter_crashlytics">flutter_crashlytics</a>プラグインがあります。<sup class="footnote-ref" id="fnref:6"><a href="#fn:6">6</a></sup><sup class="footnote-ref" id="fnref:7"><a href="#fn:7">7</a></sup></p>

<p><img height="300" src="https://qiita-image-store.s3.amazonaws.com/0/22161/b3ac6874-1ec3-0ece-a7f5-7abcd5be6142.png">
このようにスタックトレースを表示してくれています。</p>

<h3 id="admob">AdMob</h3>

<p>広告を表示するために、<a href="https://pub.dartlang.org/packages/firebase_admob">firebase_admob</a>を使用しました。バナー、インタースティシャル、リワードに対応していますが、READMEの<a href="https://github.com/flutter/plugins/tree/master/packages/firebase_admob#limitations">limitations</a>に書いてあるようにいくつか制限があります。
バナー広告は画面の上か下しか配置できなかったり、リストの途中に広告を挟むことができないのは使えないと思うかも知れませんが、<a href="https://medium.com/flutter-community/flutter-platformview-how-to-create-flutter-widgets-from-native-views-366e378115b6">PlatformView</a>がAndroid、iOSに対応したので今後に期待しています。(<a href="https://qiita.com/kikuchy/items/397b7664ad32656748bf">先日のアドベントカレンダーにも投稿されましたね</a>)</p>

<p>今回バナーはデザイン的に使いたくなったので、インタースティシャル広告を実装しました。
ルームやプロフィールを編集する画面があるのですが、その編集画面に遷移するタイミングで20%の確率で広告を表示しています。</p>

<p>プロフィール画面のinitStateでloadします</p>

<pre><code class="language-dart">Future&lt;bool&gt; loadInterstitial() {
  _interstitialAd?.dispose();
  _interstitialAd = _createInterstitialAd()..load();
  return Future.value(true);
}

InterstitialAd _createInterstitialAd() =&gt; InterstitialAd(
      adUnitId: _appConfig.adMobIds.interstitialUnitId,
      listener: (MobileAdEvent event) {},
    );
</code></pre>

<p>編集画面へ遷移するボタンタップ時のタイミングで広告を表示しています。</p>

<pre><code class="language-dart">Future&lt;bool&gt; showInterstitial() {
  return _interstitialAd.isLoaded().then((loaded) {
    if (loaded) {
      _interstitialAd?.show();
      return true;
    }
    return false;
  });
}
</code></pre>

<p>ちなみに20%の確率の実装は<a href="https://api.dartlang.org/stable/2.1.0/dart-math/Random-class.html"><code>Random</code></a>を使うとよさそうです。<sup class="footnote-ref" id="fnref:8"><a href="#fn:8">8</a></sup></p>

<pre><code class="language-dart">Random().nextInt(100) &lt;= 20
</code></pre>

<h2 id="リリースまでに必要なの">リリースまでに必要なの</h2>

<h3 id="ランチャーアイコン">ランチャーアイコン</h3>

<p>ランチャーアイコン（アプリアイコン）はリリースまでには必要になるのですが、サイズが細かく決まってたりしてなれてないと（なれてても？）アイコン作成は大変です。それを便利にするのが、<a href="https://pub.dartlang.org/packages/flutter_launcher_icons">flutter_launcher_icons</a>プラグインです。</p>

<p>(私の場合は)1024x1024の画像を1つだけ作ってpubspec.yamlに次のように書いて実行すると、Android,iOSの解像度別のアイコンをすべて作成してくれます。</p>

<pre><code class="language-yaml">  flutter_launcher_icons: &quot;^0.6.0&quot;

flutter_icons:
  android: true
  ios: true
  image_path: &quot;assets/images/launcher-icons/icon-1024x1024.png&quot;
  adaptive_icon_background: &quot;#FFFFFF&quot;
  adaptive_icon_foreground: &quot;assets/images/launcher-icons/icon-1024x1024.png&quot;
</code></pre>

<h3 id="スクリーンショット">スクリーンショット</h3>

<p>これもリリースまでには必要になります。こちらはプラグインではないのですが、<code>flutter screenshot</code>コマンドが便利だったのでご紹介。</p>

<p>いつもならAndroid Studioと端末をつなげてLogCatからScreen Captureするとか、端末側でスクショとって画像をPCに送るとかしていたのが不要になります。</p>

<p>PCと端末つなげて<code>flutter screenshot</code>を実行するだけでスクショを撮ってくれます。これは普通にAndroid,iOS開発中にも使えるので、オススメです。</p>

<pre><code class="language-sh">% flutter screenshot
Screenshot written to flutter_03.png (160kB).
</code></pre>

<h1 id="紹介した時点でのプラグインのバージョン一覧">紹介した時点でのプラグインのバージョン一覧</h1>

<table>
<thead>
<tr>
<th align="left">プラグイン</th>
<th align="left">　バージョン</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/google_sign_in">google_sign_in</a></td>
<td align="left">3.2.4</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/firebase_auth">firebase_auth</a></td>
<td align="left">0.15.4</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/cloud_firestore">cloud_firestore</a></td>
<td align="left">0.8.2+3</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/firebase_messaging">firebase_messaging</a></td>
<td align="left">2.1.0</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/flutter_facebook_login">flutter_facebook_login</a></td>
<td align="left">1.1.1</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/firebase_storage">firebase_storage</a></td>
<td align="left">1.0.4</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/firebase_analytics">firebase_analytics</a></td>
<td align="left">1.0.6</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/firebase_admob">firebase_admob</a></td>
<td align="left">0.7.0</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/firebase_ml_vision">firebase_ml_vision</a></td>
<td align="left">0.2.0+2</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/flutter_crashlytics">flutter_crashlytics</a></td>
<td align="left">0.1.1</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/image_picker">image_picker</a></td>
<td align="left">0.4.10</td>
</tr>

<tr>
<td align="left"><a href="https://github.com/btastic/flutter_native_image">flutter_native_image</a></td>
<td align="left">commit 20947f19<sup class="footnote-ref" id="fnref:9"><a href="#fn:9">9</a></sup></td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/photo_view">photo_view</a></td>
<td align="left">0.1.0</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/cached_network_image">cached_network_image</a></td>
<td align="left">0.4.2</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/barcode_scan">barcode_scan</a></td>
<td align="left">0.0.8</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/qr_flutter">qr_flutter</a></td>
<td align="left">1.1.5</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/url_launcher">url_launcher</a></td>
<td align="left">4.0.2</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/flutter_inapp_purchase">flutter_inapp_purchase</a></td>
<td align="left">0.8.5</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/shared_preferences">shared_preferences</a></td>
<td align="left">0.4.3</td>
</tr>

<tr>
<td align="left"><a href="https://pub.dartlang.org/packages/flutter_launcher_icons">flutter_launcher_icons</a></td>
<td align="left">0.7.0</td>
</tr>
</tbody>
</table>

<h1 id="本アプリのリリースについて">本アプリのリリースについて</h1>

<p>ここまでお読みいただいた方はもしかしたら触ってみたくなったかもしれませんので、リリース状況についてお伝えします。</p>

<h2 id="android">Android</h2>

<p>本日バージョン1.0.0リリースです🎉 <sup class="footnote-ref" id="fnref:10"><a href="#fn:10">10</a></sup>
<a href='https://play.google.com/store/apps/details?id=com.instantonnection.app&pcampaignid=MKT-Other-global-all-co-prtnr-py-PartBadge-Mar2515-1'><img width="300" alt='Google Play で手に入れよう' src='https://play.google.com/intl/en_us/badges/images/generic/ja_badge_web_generic.png'/></a></p>

<h2 id="ios">iOS</h2>

<p>iOSはAppStoreに審査出しました。
<img src="https://qiita-image-store.s3.amazonaws.com/0/22161/f52a10ae-334b-3092-e60c-7afb994479a2.png" alt="image.png" /></p>

<p>が、<a href="https://developer.apple.com/jp/app-store/review/guidelines/#design">Designガイドライン</a>に引っかかってリジェクトされました。
おそらくオリジナリティがないとのことだと思うので、AppStoreへのリリースは当分先になるかもしれません。</p>

<p>2019/08/02追記
iOSは3月にAppStoreにリリースできました。リンク貼るの遅くなりました。。。</p>

<p><a href="https://apps.apple.com/jp/app/%E5%8D%B3%E5%B8%AD%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E3%82%A2%E3%83%97%E3%83%AA-%E3%82%A4%E3%83%B3%E3%82%B3%E3%83%8D/id1423069453"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/22161/dc0e452f-341f-9abf-f8cf-7b19b06238e3.png"/></a></p>

<p>ちなみに、上記のオリジナリティがないというリジェクトの対応は、オンボーディングをつけることで通りました。</p>

<h1 id="ソースコードについて-2020-02-29追記">ソースコードについて ※2020/02/29追記</h1>

<p>ここで紹介したチャットアプリのコードをオープンソースにしましたので、全体的なコードを知りたい方はこちらをご覧ください。
<a href="https://github.com/kwmt/flutter-inconne">https://github.com/kwmt/flutter-inconne</a>
PR、issue、<strong>スター☆</strong>はWelcomeです！</p>

<h1 id="おわりに">おわりに</h1>

<p>以上、いかがでしたでしょうか。おそらくチャットアプリでの主要な機能については一通りご紹介できたんじゃないかなと思っていますので、この記事読んでチャットアプリが作れそう！と思ってもらえたら嬉しく思います。</p>

<p>チャット機能のみのアプリだとapple様にリジェクトされるようなので、なにかメイン機能+チャット機能とするのがいいのかもしれません。</p>

<p>この記事がFlutter開発者のみなさんの助けになれば幸いです。
ここまでお読み頂きありがとうございました。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">safe areaにかぶっているので調整が必要かもしれません。
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">firebase_storageプラグインのv1.0.3で<a href="https://github.com/flutter/plugins/pull/531/files#diff-64e1f7ca1659a9f092f80ba64377fbefL17">使い方が変わり</a>、取り急ぎ修正した感じなのでもしかしたらもっと良いやり方があるかも知れません。また、プラグインのexampleには<code>StreamBuilder</code>の使い方が書いてありますが、<code>StreamBuilder</code>を使うと表示とアップロード処理の分離できなさそうだったので使いたくありませんでした。
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">使ってみたかっただけです。
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">定期購読が停止されてるかどうかをチェックするためのサーバーをGoで作成しましたが、そのときに使わせてもらったライブラリです。
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
<li id="fn:5">簡単すぎて感動しました!
 <a class="footnote-return" href="#fnref:5"><sup>[return]</sup></a></li>
<li id="fn:6"><a href="https://github.com/flutter/flutter/issues/14765">issue</a>があります。公式サポートしてほしいと思っている人たちは多そうなので期待しています。
 <a class="footnote-return" href="#fnref:6"><sup>[return]</sup></a></li>
<li id="fn:7">Flutterプロジェクトが古いとiOSでビルドできない状態になってました。Podfileが少し変わった？ようで、その部分を変えたらビルドできるようになりました。新しいプロジェクトなら動くかと思います。
 <a class="footnote-return" href="#fnref:7"><sup>[return]</sup></a></li>
<li id="fn:8"><code>import 'dart:math';</code>が必要です。
 <a class="footnote-return" href="#fnref:8"><sup>[return]</sup></a></li>
<li id="fn:9"><a href="https://pub.dartlang.org/">https://pub.dartlang.org/</a> に公開されていないので、コミット番号にしています。
 <a class="footnote-return" href="#fnref:9"><sup>[return]</sup></a></li>
<li id="fn:10">と、言ってみたかった。
 <a class="footnote-return" href="#fnref:10"><sup>[return]</sup></a></li>
</ol>
</div>

    <div id="ad">
    <aside>
        <p>スポンサーリンク</p>
        <div class="responsive-unit">
            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3131366896030715"
                 data-ad-slot="5415567707"
                 data-ad-format="auto"></ins>
            <script>
(adsbygoogle = window.adsbygoogle || []).push({});

            </script>
        </div>
    </aside>
</div>
    <div id="share-top">
    <ul class="clearfix">
        
        <li>
            <a href="http://b.hatena.ne.jp/entry/https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" class="hatena-bookmark-button"
               data-hatena-bookmark-title="Flutter製チャットアプリを支える技術" data-hatena-bookmark-layout="vertical-balloon"
               data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img
                    src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加"
                    width="20" height="20" style="border: none;"/></a>
            <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8"
                    async="async"></script>

        </li>
        
        
        <li>
            <div class="g-plusone" data-size="tall" data-href="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/"></div>
        </li>

        
        <li>

            <div class="fb-like" data-href="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" data-layout="box_count" data-action="like"
                 data-show-faces="false" data-share="false"></div>
        </li>

        
        <li>
            <a data-pocket-label="pocket" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
            <script type="text/javascript">
                !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");
            </script>
        </li>

    </ul>
</div>
    <div id="social-bar">
	<ul class="rrssb-buttons clearfix">
      <li class="email">
          <a href="mailto:?subject=Flutter%e8%a3%bd%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%82%a2%e3%83%97%e3%83%aa%e3%82%92%e6%94%af%e3%81%88%e3%82%8b%e6%8a%80%e8%a1%93&amp;body=https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path transform="scale(0.014,-0.014) translate(0,-1670)" d="M1792 826v-794q0 -66 -47 -113t-113 -47h-1472q-66 0 -113 47t-47 113v794q44 -49 101 -87q362 -246 497 -345q57 -42 92.5 -65.5t94.5 -48t110 -24.5h1h1q51 0 110 24.5t94.5 48t92.5 65.5q170 123 498 345q57 39 100 87zM1792 1120q0 -79 -49 -151t-122 -123 q-376 -261 -468 -325q-10 -7 -42.5 -30.5t-54 -38t-52 -32.5t-57.5 -27t-50 -9h-1h-1q-23 0 -50 9t-57.5 27t-52 32.5t-54 38t-42.5 30.5q-91 64 -262 182.5t-205 142.5q-62 42 -117 115.5t-55 136.5q0 78 41.5 130t118.5 52h1472q65 0 112.5 -47t47.5 -113z"/>
                  </svg>
              </span>
              <span class="text">Email</span>
          </a>
      </li>
      <li class="facebook">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M27.825,4.783c0-2.427-2.182-4.608-4.608-4.608H4.783c-2.422,0-4.608,2.182-4.608,4.608v18.434 c0,2.427,2.181,4.608,4.608,4.608H14V17.379h-3.379v-4.608H14v-1.795c0-3.089,2.335-5.885,5.192-5.885h3.718v4.608h-3.726 c-0.408,0-0.884,0.492-0.884,1.236v1.836h4.609v4.608h-4.609v10.446h4.916c2.422,0,4.608-2.188,4.608-4.608V4.783z"/>
                  </svg>
              </span>
              <span class="text">Facebook</span>
          </a>
      </li>
			<li class="twitter">
          <a href="http://twitter.com/home?status=Flutter%e8%a3%bd%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%82%a2%e3%83%97%e3%83%aa%e3%82%92%e6%94%af%e3%81%88%e3%82%8b%e6%8a%80%e8%a1%93%20https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
		                  <path d="M24.253,8.756C24.689,17.08,18.297,24.182,9.97,24.62c-3.122,0.162-6.219-0.646-8.861-2.32 c2.703,0.179,5.376-0.648,7.508-2.321c-2.072-0.247-3.818-1.661-4.489-3.638c0.801,0.128,1.62,0.076,2.399-0.155 C4.045,15.72,2.215,13.6,2.115,11.077c0.688,0.275,1.426,0.407,2.168,0.386c-2.135-1.65-2.729-4.621-1.394-6.965 C5.575,7.816,9.54,9.84,13.803,10.071c-0.842-2.739,0.694-5.64,3.434-6.482c2.018-0.623,4.212,0.044,5.546,1.683 c1.186-0.213,2.318-0.662,3.329-1.317c-0.385,1.256-1.247,2.312-2.399,2.942c1.048-0.106,2.069-0.394,3.019-0.851 C26.275,7.229,25.39,8.196,24.253,8.756z"/>
                  </svg>
              </span>
              <span class="text">Twitter</span>
          </a>
      </li>
			<li class="linkedin">
          <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/&amp;title=Flutter%e8%a3%bd%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%82%a2%e3%83%97%e3%83%aa%e3%82%92%e6%94%af%e3%81%88%e3%82%8b%e6%8a%80%e8%a1%93&amp;summary=%e3%81%af%e3%81%98%e3%82%81%e3%81%ab%20%e4%bb%8a%e5%b9%b4%e3%81%afGoogle%20I%2fO%e3%81%ab%e8%a1%8c%e3%81%a3%e3%81%a6Flutter%e3%82%92%e7%9f%a5%e3%81%a3%e3%81%a66%e6%9c%88%e3%81%90%e3%82%89%e3%81%84%e3%81%8b%e3%82%89Flutter%e3%82%92%e8%a7%a6%e3%82%8a%e3%81%a0%e3%81%97%e3%80%81%e3%81%84%e3%82%8d%e3%81%84%e3%82%8d%e5%8b%89%e5%bc%b7%e4%bc%9a%e3%81%ab%e8%a1%8c%e3%81%a3%e3%81%9f%e3%82%8aFlutter%e6%b8%a9%e6%b3%89%e3%81%ab%e8%a1%8c%e3%81%a3%e3%81%9f%e3%82%8a%e3%80%81%e4%bb%8a%e5%b9%b4%e3%81%ae%e5%be%8c%e5%8d%8a%e3%81%afFlutter%e4%b8%89%e6%98%a7%e3%81%a7%e3%81%97%e3%81%9f%e3%80%82%0a%e3%81%9d%e3%82%93%e3%81%aa%e4%b8%ad%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%82%a2%e3%83%97%e3%83%aa%e3%82%92%e4%bd%9c%e3%81%a3%e3%81%9f%e3%81%ae%e3%81%a7%e3%80%81%e3%81%9d%e3%82%8c%e3%81%9e%e3%82%8c%e6%a9%9f%e8%83%bd%e3%82%92%e3%81%a9%e3%81%ae%e3%82%88%e3%81%86%e3%81%ab%e5%ae%9f%e8%a3%85%e3%81%97%e3%81%9f%e3%81%8b%e3%82%b3%e3%83%bc%e3%83%89%e3%82%92%e4%ba%a4%e3%81%88%e3%81%a4%e3%81%a4%e5%b0%91%e3%81%97%e3%81%9a%e3%81%a4%e3%81%94%e7%b4%b9%e4%bb%8b%e3%81%97%e3%81%9f%e3%81%84%e3%81%a8%e6%80%9d%e3%81%84%e3%81%be%e3%81%99%e3%80%82%0a%e9%96%8b%e7%99%ba%e7%92%b0%e5%a2%83%e3%81%af%e4%b8%8b%e8%a8%98%e3%81%ae%e3%81%a8%e3%81%8a%e3%82%8a%e3%81%a7%e3%81%99%e3%80%82%0a%25%20flutter%20doctor%20Doctor%20summary%20%28to%20see%20all%20details%2c%20run%20flutter%20doctor%20-v%29%3a%20%5b%e2%9c%93%5d%20Flutter%20%28Channel%20beta%2c%20v1.0.0%2c%20on%20Mac%20OS%20X%2010.14.1%2018B75%2c%20locale%20en-JP%29%20%5b%e2%9c%93%5d%20Android%20toolchain%20-%20develop%20for%20Android%20devices%20%28Android%20SDK%2028.0.3%29%20%5b%e2%9c%93%5d%20iOS%20toolchain%20-%20develop%20for%20iOS%20devices%20%28Xcode%2010.1%29%20%5b%e2%9c%93%5d%20Android%20Studio%20%28version%203.2%29%20%5b%e2%9c%93%5d%20VS%20Code%20%28version%201.29.1%29%20%5b%e2%9c%93%5d%20Connected%20device%20%282%20available%29%20%20%e3%81%be%e3%81%9a%e3%81%a9%e3%82%93%e3%81%aa%e6%a9%9f%e8%83%bd%e3%82%92%e4%bd%9c%e3%81%a3%e3%81%9f%e3%81%8b%ef%bc%9f%20%e5%a4%a7%e3%81%8d%e3%81%8f%e5%88%86%e3%81%91%e3%82%8b%e3%81%a8%e6%ac%a1%e3%81%ae%e3%82%88%e3%81%86%e3%81%ab%e3%81%aa%e3%82%8b%e3%81%8b%e3%81%aa%e3%81%a8%e6%80%9d%e3%81%84%e3%81%be%e3%81%99%e3%80%82..." class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M25.424,15.887v8.447h-4.896v-7.882c0-1.979-0.709-3.331-2.48-3.331c-1.354,0-2.158,0.911-2.514,1.803 c-0.129,0.315-0.162,0.753-0.162,1.194v8.216h-4.899c0,0,0.066-13.349,0-14.731h4.899v2.088c-0.01,0.016-0.023,0.032-0.033,0.048 h0.033V11.69c0.65-1.002,1.812-2.435,4.414-2.435C23.008,9.254,25.424,11.361,25.424,15.887z M5.348,2.501 c-1.676,0-2.772,1.092-2.772,2.539c0,1.421,1.066,2.538,2.717,2.546h0.032c1.709,0,2.771-1.132,2.771-2.546 C8.054,3.593,7.019,2.501,5.343,2.501H5.348z M2.867,24.334h4.897V9.603H2.867V24.334z"/>
                  </svg>
              </span>
              <span class="text">LinkedIn</span>
          </a>
      </li>
      <li class="tumblr">
					<script>
						document.write('<a href="http://www.tumblr.com/share?v=3&amp;u=' + encodeURIComponent('https:\/\/kwmt27.net\/2020\/03\/26\/the-technology-behind-flutter-chat-app\/') + '&amp;t=Flutter製チャットアプリを支える技術" class="popup">');
					</script>
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
											<path d="M18.02 21.842c-2.029 0.052-2.422-1.396-2.439-2.446v-7.294h4.729V7.874h-4.71V1.592c0 0-3.653 0-3.714 0 s-0.167 0.053-0.182 0.186c-0.218 1.935-1.144 5.33-4.988 6.688v3.637h2.927v7.677c0 2.8 1.7 6.7 7.3 6.6 c1.863-0.03 3.934-0.795 4.392-1.453l-1.22-3.539C19.595 21.6 18.7 21.8 18 21.842z"/>
									</svg>
              </span>
              <span class="text">Tumblr</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="reddit">
          <a href="http://www.reddit.com/submit?url=https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/">
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
											<g>
													<path d="M11.794 15.316c0-1.029-0.835-1.895-1.866-1.895c-1.03 0-1.893 0.865-1.893 1.895s0.863 1.9 1.9 1.9 C10.958 17.2 11.8 16.3 11.8 15.316z"/>
													<path d="M18.1 13.422c-1.029 0-1.895 0.864-1.895 1.895c0 1 0.9 1.9 1.9 1.865c1.031 0 1.869-0.836 1.869-1.865 C19.969 14.3 19.1 13.4 18.1 13.422z"/>
													<path d="M17.527 19.791c-0.678 0.678-1.826 1.006-3.514 1.006c-0.004 0-0.009 0-0.014 0c-0.004 0-0.01 0-0.015 0 c-1.686 0-2.834-0.328-3.51-1.005c-0.264-0.265-0.693-0.265-0.958 0c-0.264 0.265-0.264 0.7 0 1 c0.943 0.9 2.4 1.4 4.5 1.402c0.005 0 0 0 0 0c0.005 0 0 0 0 0c2.066 0 3.527-0.459 4.47-1.402 c0.265-0.264 0.265-0.693 0.002-0.958C18.221 19.5 17.8 19.5 17.5 19.791z"/>
													<path d="M27.707 13.267c0-1.785-1.453-3.237-3.236-3.237c-0.793 0-1.518 0.287-2.082 0.761c-2.039-1.295-4.646-2.069-7.438-2.219 l1.483-4.691l4.062 0.956c0.071 1.4 1.3 2.6 2.7 2.555c1.488 0 2.695-1.208 2.695-2.695C25.881 3.2 24.7 2 23.2 2 c-1.059 0-1.979 0.616-2.42 1.508l-4.633-1.091c-0.344-0.081-0.693 0.118-0.803 0.455l-1.793 5.7 C10.548 8.6 7.7 9.4 5.6 10.75C5.006 10.3 4.3 10 3.5 10.029c-1.785 0-3.237 1.452-3.237 3.2 c0 1.1 0.6 2.1 1.4 2.69c-0.04 0.272-0.061 0.551-0.061 0.831c0 2.3 1.3 4.4 3.7 5.9 c2.299 1.5 5.3 2.3 8.6 2.325c3.228 0 6.271-0.825 8.571-2.325c2.387-1.56 3.7-3.66 3.7-5.917 c0-0.26-0.016-0.514-0.051-0.768C27.088 15.5 27.7 14.4 27.7 13.267z M23.186 3.355c0.74 0 1.3 0.6 1.3 1.3 c0 0.738-0.6 1.34-1.34 1.34s-1.342-0.602-1.342-1.34C21.844 4 22.4 3.4 23.2 3.355z M1.648 13.3 c0-1.038 0.844-1.882 1.882-1.882c0.31 0 0.6 0.1 0.9 0.209c-1.049 0.868-1.813 1.861-2.26 2.9 C1.832 14.2 1.6 13.8 1.6 13.267z M21.773 21.57c-2.082 1.357-4.863 2.105-7.831 2.105c-2.967 0-5.747-0.748-7.828-2.105 c-1.991-1.301-3.088-3-3.088-4.782c0-1.784 1.097-3.484 3.088-4.784c2.081-1.358 4.861-2.106 7.828-2.106 c2.967 0 5.7 0.7 7.8 2.106c1.99 1.3 3.1 3 3.1 4.784C24.859 18.6 23.8 20.3 21.8 21.57z M25.787 14.6 c-0.432-1.084-1.191-2.095-2.244-2.977c0.273-0.156 0.59-0.245 0.928-0.245c1.035 0 1.9 0.8 1.9 1.9 C26.354 13.8 26.1 14.3 25.8 14.605z"/>
											</g>
									</svg>
              </span>
              <span class="text">Reddit</span>
          </a>
      </li>
      <li class="googleplus">
          <a href="https://plus.google.com/share?url=https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <g>
                          <path d="M14.703,15.854l-1.219-0.948c-0.372-0.308-0.88-0.715-0.88-1.459c0-0.748,0.508-1.223,0.95-1.663 c1.42-1.119,2.839-2.309,2.839-4.817c0-2.58-1.621-3.937-2.399-4.581h2.097l2.202-1.383h-6.67c-1.83,0-4.467,0.433-6.398,2.027 C3.768,4.287,3.059,6.018,3.059,7.576c0,2.634,2.022,5.328,5.604,5.328c0.339,0,0.71-0.033,1.083-0.068 c-0.167,0.408-0.336,0.748-0.336,1.324c0,1.04,0.551,1.685,1.011,2.297c-1.524,0.104-4.37,0.273-6.467,1.562 c-1.998,1.188-2.605,2.916-2.605,4.137c0,2.512,2.358,4.84,7.289,4.84c5.822,0,8.904-3.223,8.904-6.41 c0.008-2.327-1.359-3.489-2.829-4.731H14.703z M10.269,11.951c-2.912,0-4.231-3.765-4.231-6.037c0-0.884,0.168-1.797,0.744-2.511 c0.543-0.679,1.489-1.12,2.372-1.12c2.807,0,4.256,3.798,4.256,6.242c0,0.612-0.067,1.694-0.845,2.478 c-0.537,0.55-1.438,0.948-2.295,0.951V11.951z M10.302,25.609c-3.621,0-5.957-1.732-5.957-4.142c0-2.408,2.165-3.223,2.911-3.492 c1.421-0.479,3.25-0.545,3.555-0.545c0.338,0,0.52,0,0.766,0.034c2.574,1.838,3.706,2.757,3.706,4.479 c-0.002,2.073-1.736,3.665-4.982,3.649L10.302,25.609z"/>
                          <polygon points="23.254,11.89 23.254,8.521 21.569,8.521 21.569,11.89 18.202,11.89 18.202,13.604 21.569,13.604 21.569,17.004 23.254,17.004 23.254,13.604 26.653,13.604 26.653,11.89"/>
                      </g>
                  </svg>
              </span>
              <span class="text">Google+</span>
          </a>
      </li>
      <li class="pinterest">
          <script>
						var imgurl = "https:\/\/kwmt27.net\/logo.png";
						var firstimg = document.getElementsByClassName("post")[0].getElementsByTagName("img")[0];
						if (firstimg !== undefined) {
							imgurl = firstimg.src;
						}
						document.write('<a href="http://pinterest.com/pin/create/button/?url=https:\/\/kwmt27.net\/2020\/03\/26\/the-technology-behind-flutter-chat-app\/&amp;media=' + imgurl + '&amp;description=Flutter製チャットアプリを支える技術" class="popup">');
					</script>
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
		                  <path d="M14.021,1.57C6.96,1.57,1.236,7.293,1.236,14.355c0,7.062,5.724,12.785,12.785,12.785c7.061,0,12.785-5.725,12.785-12.785 C26.807,7.294,21.082,1.57,14.021,1.57z M15.261,18.655c-1.161-0.09-1.649-0.666-2.559-1.219c-0.501,2.626-1.113,5.145-2.925,6.458 c-0.559-3.971,0.822-6.951,1.462-10.116c-1.093-1.84,0.132-5.545,2.438-4.632c2.837,1.123-2.458,6.842,1.099,7.557 c3.711,0.744,5.227-6.439,2.925-8.775c-3.325-3.374-9.678-0.077-8.897,4.754c0.19,1.178,1.408,1.538,0.489,3.168 C7.165,15.378,6.53,13.7,6.611,11.462c0.131-3.662,3.291-6.227,6.46-6.582c4.007-0.448,7.771,1.474,8.29,5.239 c0.579,4.255-1.816,8.865-6.102,8.533L15.261,18.655z"/>
                  </svg>
              </span>
              <span class="text">Pinterest</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="pocket">
          <a href="https://getpocket.com/save?url=https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/"  class="popup">
              <span class="icon">
                  <svg width="32px" height="28px" viewBox="0 0 32 28" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                      <path d="M28.7817528,0.00172488695 C30.8117487,0.00431221738 31.9749312,1.12074529 31.9644402,3.10781507 C31.942147,6.67703739 32.1336065,10.2669583 31.8057648,13.8090137 C30.7147076,25.5813672 17.2181194,31.8996281 7.20714461,25.3808491 C2.71833574,22.4571656 0.196577202,18.3122624 0.0549495772,12.9357897 C-0.0342233715,9.5774348 0.00642900214,6.21519891 0.0300336062,2.85555035 C0.0405245414,1.1129833 1.21157517,0.0146615391 3.01995012,0.00819321302 C7.34746087,-0.00603710433 11.6775944,0.00431221738 16.0064164,0.00172488695 C20.2644248,0.00172488695 24.5237444,-0.00215610869 28.7817528,0.00172488695 L28.7817528,0.00172488695 Z M8.64885184,7.85611511 C7.38773662,7.99113854 6.66148108,8.42606978 6.29310958,9.33228474 C5.90114134,10.2969233 6.17774769,11.1421181 6.89875951,11.8276216 C9.35282156,14.161969 11.8108164,16.4924215 14.2976518,18.7943114 C15.3844131,19.7966007 16.5354102,19.7836177 17.6116843,18.7813283 C20.0185529,16.5495467 22.4070683,14.2982907 24.7824746,12.0327533 C25.9845979,10.8850542 26.1012707,9.56468083 25.1469132,8.60653379 C24.1361858,7.59255976 22.8449191,7.6743528 21.5890476,8.85191291 C19.9936451,10.3488554 18.3680912,11.8172352 16.8395462,13.3777945 C16.1342655,14.093159 15.7200114,14.0048744 15.0566806,13.3440386 C13.4599671,11.7484252 11.8081945,10.2060421 10.1262706,8.70001155 C9.65564653,8.27936164 9.00411403,8.05345704 8.64885184,7.85611511 L8.64885184,7.85611511 L8.64885184,7.85611511 Z"></path>
                  </svg>
              </span>
              <span class="text">Pocket</span>
          </a>
      </li>
  </ul>
</div>

    <div id="recent">
  <section>
    <h5>Recent Posts:</h5>
    <ul>
      
      <li>
        <a href="https://kwmt27.net/2021/12/31/looking-back-2021/">2021年振り返り - 1 Minutes</a>
      </li>
      
      <li>
        <a href="https://kwmt27.net/2021/07/30/android-camera2-light-on-by-light-sensor/">Camera2APIでカメラプレビュー中に光センサーの値によってライトを自動でON/OFFにする - 1 Minutes</a>
      </li>
      
      <li>
        <a href="https://kwmt27.net/2021/06/12/jetpack-compose-camerax/">Jetpack ComposeでCameraXを実装する - 1 Minutes</a>
      </li>
      
      <li>
        <a href="https://kwmt27.net/2021/06/12/android-update-targertsdk-from-28-to-30/">Android targetSdkVersionを28から30への変更したときのメモ - 1 Minutes</a>
      </li>
      
      <li>
        <a href="https://kwmt27.net/2021/05/15/jetpack-compose-searchbar/">Jetpack Composeでインクリメンタルサーチ(SearchBar UI)を実装するには - 1 Minutes</a>
      </li>
      
    </ul>
  </section>
</div>

    
    <div id="comments">
    
    
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'kwmt27';
      var disqus_identifier = 'https:\/\/kwmt27.net\/2020\/03\/26\/the-technology-behind-flutter-chat-app\/';
      var disqus_title = 'Flutter製チャットアプリを支える技術';
      var disqus_url = 'https:\/\/kwmt27.net\/2020\/03\/26\/the-technology-behind-flutter-chat-app\/';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
</div>

</article>  

</main>
		<footer id="footer">
			<section id="footer-message">&copy; Androg. All rights reserved. Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>. <a href="https://github.com/kathyqian/crisp-ghost-theme" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
		</footer>

    <script>
      (function(c,f){asyncLoader=function(i,h){i.foreach(function(k,j){e(j,d(j),h)});if(typeof h.callback=="function"){var g=setInterval(function(){if(f.readyState==="complete"){clearInterval(g);h.callback()}},10)}};var d=function(g){var h=g.split(".");return h[h.length-1]},e=function(h,i,g){switch(i){case"js":a(h,g);break;case"css":b(h);break;default:break}},a=function(i,h){var g=document.createElement("script");g.type="text/javascript";g.async=true;g.src=i;document.getElementsByTagName("head")[0].appendChild(g)},b=function(g){var h=document.createElement("link");h.type="text/css";h.rel="stylesheet";h.href=g;document.getElementsByTagName("head")[0].appendChild(h)};Array.prototype.foreach=function(h){for(var g=0;g<this.length;g++){h(g,this[g])}}})(this,document);

      var WebFontConfig={google:{families:["Open Sans:300italic,700italic,300,700","Bree+Serif"]}};
      asyncLoader([
        "//netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css",
        "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js",
        "//cdnjs.cloudflare.com/ajax/libs/webfont/1.5.16/webfontloader.js",
        "//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js",
        "//cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.1/es5/tex-mml-chtml.js"
      ],{
        callback:function(){
          asyncLoader([
            "https:\/\/kwmt27.net\/css/rrssb.css",
            "https:\/\/kwmt27.net\/js/gist.min.js", 
            "https:\/\/kwmt27.net\/js/rrssb.min.js",
            "//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css"
          ], { callback:function() {
              hljs.initHighlighting();
          }});
        }
      });
    </script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$','$'], ['\\(','\\)']]
        }
      };
    </script>    
	
    <script>
    	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      	ga('create', 'UA-39334884-1', 'auto');
      	ga('send', 'pageview');
    </script>
  
	</body>
</html>