<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Flutter製チャットアプリを支える技術 | Androg</title><meta name=description content="はじめに今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったりFlutter温泉に行ったり、今年の後半はFlutter三昧でした。
そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。
開発環境は下記のとおりです。
% flutter doctor Doctor summary (to see all details, run flutter doctor -v): [✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP) [✓] Android toolchain - develop for Android devices (Android SDK 28.0.3) [✓] iOS toolchain - develop for iOS devices (Xcode 10.1) [✓] Android Studio (version 3.2) [✓] VS Code (version 1.29.1) [✓] Connected device (2 available) まずどんな機能を作ったか？大きく分けると次のようになるかなと思います。
会員登録・ログイン チャットルーム（以下、ルーム）作成できる ルーム一覧を見ることができる ルームでチャット(テキスト、画像の送信)ができる 既存のルームにユーザーが参加できる 自分のプロフィールを見ることができる アプリ内課金で定期購読できる それぞれ見ていきます。"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Flutter製チャットアプリを支える技術"><meta name=twitter:description content="はじめに今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったりFlutter温泉に行ったり、今年の後半はFlutter三昧でした。
そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。
開発環境は下記のとおりです。
% flutter doctor Doctor summary (to see all details, run flutter doctor -v): [✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP) [✓] Android toolchain - develop for Android devices (Android SDK 28.0.3) [✓] iOS toolchain - develop for iOS devices (Xcode 10.1) [✓] Android Studio (version 3.2) [✓] VS Code (version 1.29.1) [✓] Connected device (2 available) まずどんな機能を作ったか？大きく分けると次のようになるかなと思います。
会員登録・ログイン チャットルーム（以下、ルーム）作成できる ルーム一覧を見ることができる ルームでチャット(テキスト、画像の送信)ができる 既存のルームにユーザーが参加できる 自分のプロフィールを見ることができる アプリ内課金で定期購読できる それぞれ見ていきます。"><meta property="og:title" content="Flutter製チャットアプリを支える技術"><meta property="og:description" content="はじめに今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったりFlutter温泉に行ったり、今年の後半はFlutter三昧でした。
そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。
開発環境は下記のとおりです。
% flutter doctor Doctor summary (to see all details, run flutter doctor -v): [✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP) [✓] Android toolchain - develop for Android devices (Android SDK 28.0.3) [✓] iOS toolchain - develop for iOS devices (Xcode 10.1) [✓] Android Studio (version 3.2) [✓] VS Code (version 1.29.1) [✓] Connected device (2 available) まずどんな機能を作ったか？大きく分けると次のようになるかなと思います。
会員登録・ログイン チャットルーム（以下、ルーム）作成できる ルーム一覧を見ることができる ルームでチャット(テキスト、画像の送信)ができる 既存のルームにユーザーが参加できる 自分のプロフィールを見ることができる アプリ内課金で定期購読できる それぞれ見ていきます。"><meta property="og:type" content="article"><meta property="og:url" content="https://kwmt27.net/2020/03/26/the-technology-behind-flutter-chat-app/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-03-26T02:00:00+09:00"><meta property="article:modified_time" content="2020-03-26T02:00:00+09:00"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/sass/main.css><link rel=stylesheet href=/zoomjs/zoom.min.css><script src=/js/lazysizes.min.js></script>
<link rel=apple-touch-icon href=/apple-touch-icon.png><link rel="shortcut icon" href=/favicon.png type=image/x-icon><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=icon href=/logo.svg sizes=any type=image/svg+xml><script data-ad-client=ca-pub-3131366896030715 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://kwmt27.net/>Androg</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/flutter/ title=flutter>flutter</a></div><h1>Flutter製チャットアプリを支える技術</h1><h2 class=subheading></h2><span class=meta>Posted by kwmt27
on Thu, Mar 26, 2020</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=はじめに>はじめに<a class=anchorjs-link href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab></a></h1><p>今年はGoogle I/Oに行ってFlutterを知って6月ぐらいからFlutterを触りだし、いろいろ勉強会に行ったり<a href=https://gdg.connpass.com/event/98013/ target=_blank>Flutter温泉</a>に行ったり、今年の後半はFlutter三昧でした。</p><p>そんな中チャットアプリを作ったので、それぞれ機能をどのように実装したかコードを交えつつ少しずつご紹介したいと思います。</p><p>開発環境は下記のとおりです。</p><pre tabindex=0><code>% flutter doctor
Doctor summary (to see all details, run flutter doctor -v):
[✓] Flutter (Channel beta, v1.0.0, on Mac OS X 10.14.1 18B75, locale en-JP)
[✓] Android toolchain - develop for Android devices (Android SDK 28.0.3)
[✓] iOS toolchain - develop for iOS devices (Xcode 10.1)
[✓] Android Studio (version 3.2)
[✓] VS Code (version 1.29.1)
[✓] Connected device (2 available)
</code></pre><h1 id=まずどんな機能を作ったか>まずどんな機能を作ったか？<a class=anchorjs-link href=#%e3%81%be%e3%81%9a%e3%81%a9%e3%82%93%e3%81%aa%e6%a9%9f%e8%83%bd%e3%82%92%e4%bd%9c%e3%81%a3%e3%81%9f%e3%81%8b></a></h1><p>大きく分けると次のようになるかなと思います。</p><ul><li>会員登録・ログイン</li><li>チャットルーム（以下、ルーム）作成できる</li><li>ルーム一覧を見ることができる</li><li>ルームでチャット(テキスト、画像の送信)ができる</li><li>既存のルームにユーザーが参加できる</li><li>自分のプロフィールを見ることができる</li><li>アプリ内課金で定期購読できる</li></ul><p>それぞれ見ていきます。</p><h2 id=会員登録ログイン>会員登録・ログイン<a class=anchorjs-link href=#%e4%bc%9a%e5%93%a1%e7%99%bb%e9%8c%b2%e3%83%ad%e3%82%b0%e3%82%a4%e3%83%b3></a></h2><p>チャットアプリなので、だれが投稿したか知りたいので、会員登録・ログインをできるようにしました。
これは、<a href=https://pub.dartlang.org/packages/firebase_auth target=_blank>firebase_auth</a>プラグインを使っていて、現在はGoogleログインと、Facebookログインに対応しています。</p><p>まずこんな感じで表示されるGoogleログインボタンのUIの実装を見てみます。</p><p>signInButtonというWidgetを作成し、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-signin_button.dart data-lang=signin_button.dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Widget signInButton(title, uri,
</span></span><span style=display:flex><span>    [color <span style=color:#f92672>=</span> <span style=color:#66d9ef>const</span> Color.fromRGBO(<span style=color:#ae81ff>68</span>, <span style=color:#ae81ff>68</span>, <span style=color:#ae81ff>76</span>, .<span style=color:#ae81ff>8</span>)]) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Container(
</span></span><span style=display:flex><span>    padding: <span style=color:#66d9ef>const</span> EdgeInsets.all(<span style=color:#ae81ff>16.0</span>),
</span></span><span style=display:flex><span>    child: Center(
</span></span><span style=display:flex><span>      child: Row(
</span></span><span style=display:flex><span>        crossAxisAlignment: CrossAxisAlignment.center,
</span></span><span style=display:flex><span>        children: <span style=color:#f92672>&lt;</span>Widget<span style=color:#f92672>&gt;</span>[
</span></span><span style=display:flex><span>          Image.asset(
</span></span><span style=display:flex><span>            uri,
</span></span><span style=display:flex><span>            width: <span style=color:#ae81ff>25.0</span>,
</span></span><span style=display:flex><span>          ),
</span></span><span style=display:flex><span>          Padding(
</span></span><span style=display:flex><span>            child: Text(
</span></span><span style=display:flex><span>              title,
</span></span><span style=display:flex><span>              style: TextStyle(
</span></span><span style=display:flex><span>                fontFamily: <span style=color:#e6db74>&#39;Roboto&#39;</span>,
</span></span><span style=display:flex><span>                color: color,
</span></span><span style=display:flex><span>              ),
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>            padding: EdgeInsets.only(left: <span style=color:#ae81ff>15.0</span>),
</span></span><span style=display:flex><span>          ),
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使う側は例えば次のように使います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>MaterialButton(
</span></span><span style=display:flex><span>  child: signInButton(Strings.of(context).signInWithGoogle,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;assets/images/google.png&#39;</span>),
</span></span><span style=display:flex><span>  onPressed: _isAgree <span style=color:#f92672>?</span> _handleSignInWithGoogle <span style=color:#f92672>:</span> _showError,
</span></span><span style=display:flex><span>  color: Colors.white,
</span></span><span style=display:flex><span>),
</span></span></code></pre></div><p>ログインとは直接関係ないですが<code>_isAgree</code>はプライバシーポリシーと利用規約に同意したかどうかで、同意していれば<code>_handleSignInWithGoogle</code>を呼び、同意してなければエラーにしています。</p><p>また、<code>Strings.of(context).signInWithGoogle</code>の部分は多言語対応していて、Android のstringsリソースをイメージしています(<a href=https://qiita.com/jiro-aqua/items/fd9896682ca09018fdd3 target=_blank>こちら</a>が参考になりました)。</p><p>ボタンができたので、Googleログインの処理は次のような感じにしています。</p><p><code>_googleSignIn</code>を準備して、</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> GoogleSignIn _googleSignIn <span style=color:#f92672>=</span> GoogleSignIn(
</span></span><span style=display:flex><span>    scopes: <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>String</span><span style=color:#f92672>&gt;</span>[<span style=color:#e6db74>&#39;email&#39;</span>],
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>ログインボタンが押されたタイミングで、下記のようにします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span>FirebaseUser<span style=color:#f92672>&gt;</span> signInWithGoogle() <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  GoogleSignInAccount googleUser <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> _googleSignIn.signIn();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (googleUser <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  GoogleSignInAuthentication googleAuth <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> googleUser.authentication;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> AuthCredential credential <span style=color:#f92672>=</span> GoogleAuthProvider.getCredential(
</span></span><span style=display:flex><span>    accessToken: googleAuth.accessToken,
</span></span><span style=display:flex><span>    idToken: googleAuth.idToken,
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  FirebaseUser user <span style=color:#f92672>=</span> (<span style=color:#66d9ef>await</span> _auth.signInWithCredential(credential)).user;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> user;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>プラグインが<a href=https://docs.flutter.io/flutter/services/PlatformException-class.html target=_blank><code>PlatformException</code></a>を投げることがあるので、try catchして、PlatformExceptionにキャストすると<a href=https://docs.flutter.io/flutter/services/PlatformException/code.html target=_blank><code>code</code></a>が取得できるので、それでエラー判定するとよいかと思います。ただし、プラグインによっては、違うエラーだけど<code>code</code>が全部一緒だったり、iOSとAndroidで<code>code</code>が異なっていたりする場合があるので、プラグインによって対応を変えなければいけないことがあります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ↑のsignIn処理のため省略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} <span style=color:#66d9ef>catch</span> (error) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (error <span style=color:#66d9ef>is</span> PlatformException) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (error.code) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> GoogleSignIn.kSignInFailedError:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>case</span> GoogleSignIn.kSignInCanceledError:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>case</span> GoogleSignIn.kSignInRequiredError:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>case</span> GoogleSignInAccount.kFailedToRecoverAuthError:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>case</span> GoogleSignInAccount.kUserRecoverableAuthError:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>あと、<a href=https://pub.dartlang.org/packages/flutter_firebase_ui target=_blank>flutter_firebase_ui</a>を使うと少しだけ楽に作れますが、ボタンを押したイベントが取れずプログレスを出すことができないため、それぞれ<a href=https://pub.dartlang.org/packages/google_sign_in target=_blank>google_sign_in</a>と<a href=https://pub.dartlang.org/packages/flutter_facebook_login target=_blank>flutter_facebook_login</a>をそれぞれ使っています。</p><h2 id=ルーム作成機能>ルーム作成機能<a class=anchorjs-link href=#%e3%83%ab%e3%83%bc%e3%83%a0%e4%bd%9c%e6%88%90%e6%a9%9f%e8%83%bd></a></h2><p>ルームを作成するのに、下図のようにルーム画像とルーム名を入力してもらうようにしました。</p><p>黄色の円をタップすると画像を選択するようにし、TextFieldにはルーム名を入力できます。</p><p>これをコードで見ると次のようにしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Widget roomImageWidget <span style=color:#f92672>=</span> GestureDetector(
</span></span><span style=display:flex><span>  child: Stack(
</span></span><span style=display:flex><span>    alignment: <span style=color:#66d9ef>const</span> Alignment(<span style=color:#ae81ff>0.6</span>, <span style=color:#ae81ff>0.6</span>),
</span></span><span style=display:flex><span>    children: [
</span></span><span style=display:flex><span>      ImageUtils.circleImageProvider(_previewImage(_imageFile),
</span></span><span style=display:flex><span>          radius: <span style=color:#ae81ff>100.0</span>, text: _inputtingRoomName),
</span></span><span style=display:flex><span>      Icon(Icons.camera_alt),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>  ),
</span></span><span style=display:flex><span>  onTap: () <span style=color:#f92672>=&gt;</span> _onTapRoomImage(context),
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>円のWidgetとカメラアイコンのWidgetを重ねていますが、このように2つ以上のWidgetを重ねるには、<code>Stack</code>(<a href=https://flutter.io/docs/development/ui/layout#stack target=_blank>こちら</a>が参考になるかと思います)を使います。
また、全体をタップできるようにしたいため、Stackを<a href=https://docs.flutter.io/flutter/widgets/GestureDetector-class.html target=_blank><code>GestureDetector</code></a>でWrapしています。</p><p>画像を円形に表示するには、circleImageProviderの自作メソッドの中でやっているのですが、次のように<a href=https://docs.flutter.io/flutter/material/CircleAvatar-class.html target=_blank><code>CircleAvatar</code></a>を使うと便利かと思います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>CircleAvatar(
</span></span><span style=display:flex><span>  child: child,
</span></span><span style=display:flex><span>  backgroundColor: Colors.yellow,
</span></span><span style=display:flex><span>  backgroundImage: imageProvider,
</span></span><span style=display:flex><span>  radius: radius,
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h3 id=bottomsheetを使って選択>BottomSheetを使って選択<a class=anchorjs-link href=#bottomsheet%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e9%81%b8%e6%8a%9e></a></h3><p>ルーム画像を設定するために先程の黄色の画像をタップすると、「ギャラリー」か「カメラ」をBtoomSheetを使って選択できるようにしています。<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>これを実装するには、次のように<a href=https://docs.flutter.io/flutter/material/showModalBottomSheet.html target=_blank><code>showModalBottomSheet</code></a>(<a href=https://flutterdoc.com/bottom-sheets-in-flutter-ec05c90453e7 target=_blank>こちら</a>が参考になるかと思います)を使います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> showCameraSelector(BuildContext context,
</span></span><span style=display:flex><span>        VoidCallback onTapGallery, VoidCallback onTapCamera) <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>    showModalBottomSheet<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span>(
</span></span><span style=display:flex><span>        context: context,
</span></span><span style=display:flex><span>        builder: (BuildContext context) <span style=color:#f92672>=&gt;</span> Column(
</span></span><span style=display:flex><span>              mainAxisSize: MainAxisSize.min,
</span></span><span style=display:flex><span>              children: <span style=color:#f92672>&lt;</span>Widget<span style=color:#f92672>&gt;</span>[
</span></span><span style=display:flex><span>                ListTile(
</span></span><span style=display:flex><span>                  leading: Icon(Icons.photo_library),
</span></span><span style=display:flex><span>                  title: Text(Strings.of(context).gallery),
</span></span><span style=display:flex><span>                  onTap: onTapGallery,
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>                ListTile(
</span></span><span style=display:flex><span>                  leading: Icon(Icons.camera_alt),
</span></span><span style=display:flex><span>                  title: Text(Strings.of(context).camera),
</span></span><span style=display:flex><span>                  onTap: onTapCamera,
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>              ],
</span></span><span style=display:flex><span>            ));
</span></span></code></pre></div><p><code>onTapGallery</code>や<code>onTapCamera</code>では、好みの写真プラグインを使えばよいかと思います。今回は<a href=https://pub.dartlang.org/packages/image_picker target=_blank>image_picker</a>を使いました。</p><h3 id=画像の圧縮>画像の圧縮<a class=anchorjs-link href=#%e7%94%bb%e5%83%8f%e3%81%ae%e5%9c%a7%e7%b8%ae></a></h3><p>画像のアップロード前に圧縮しているのですが、プラグインを調べると最初に目についたのが<a href=https://pub.dartlang.org/packages/image target=_blank>Image</a>プラグインだったのでこちらを使っていました。が、Image.decodeが4,5分かかって使い物にならないので、<a href=https://github.com/btastic/flutter_native_image target=_blank>flutter_native_image</a>を使っています。こちらはだいたい100ms以内で終わってくれるので早いです！</p><p>実装例は次のとおりです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-image.dart data-lang=image.dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;dart:io&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:flutter_native_image/flutter_native_image.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Image</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>/// 画像を圧縮する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// https://stackoverflow.com/a/50998865
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// ↓に変更
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// https://github.com/flutter/flutter/issues/19383#issuecomment-405130684
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// https://github.com/btastic/flutter_native_image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// @param file オリジナルファイル
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>/// @return 圧縮されたfile
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> Future<span style=color:#f92672>&lt;</span>File<span style=color:#f92672>&gt;</span> compress(File file) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>    ImageProperties properties <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> FlutterNativeImage.getImageProperties(file.path);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> FlutterNativeImage.compressImage(file.path,
</span></span><span style=display:flex><span>        quality: <span style=color:#ae81ff>80</span>,
</span></span><span style=display:flex><span>        targetWidth: <span style=color:#ae81ff>600</span>,
</span></span><span style=display:flex><span>        targetHeight: (properties.height <span style=color:#f92672>*</span> <span style=color:#ae81ff>600</span> <span style=color:#f92672>/</span> properties.width).round());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=画像のアップロード>画像のアップロード<a class=anchorjs-link href=#%e7%94%bb%e5%83%8f%e3%81%ae%e3%82%a2%e3%83%83%e3%83%97%e3%83%ad%e3%83%bc%e3%83%89></a></h3><p>画像のアップロード先はCloud Storageにしていますので、<a href=https://pub.dartlang.org/packages/firebase_storage target=_blank>firebase_storage</a>プラグインを使用しています。
画像をアップロードして、アップロード先のURLを知りたいのでコードは次のようにしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>String</span><span style=color:#f92672>&gt;</span> uploadImage(File file) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> timestamp <span style=color:#f92672>=</span> DateTime.now().millisecondsSinceEpoch;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>String</span> subDirectoryName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;images&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> StorageReference ref <span style=color:#f92672>=</span> storage
</span></span><span style=display:flex><span>      .ref()
</span></span><span style=display:flex><span>      .child(subDirectoryName)
</span></span><span style=display:flex><span>      .child(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>${</span>timestamp<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> StorageUploadTask uploadTask <span style=color:#f92672>=</span> ref.putFile(
</span></span><span style=display:flex><span>      file,
</span></span><span style=display:flex><span>      StorageMetadata(
</span></span><span style=display:flex><span>        contentType: <span style=color:#e6db74>&#34;image/jpeg&#34;</span>,
</span></span><span style=display:flex><span>      ));
</span></span><span style=display:flex><span>  StorageTaskSnapshot snapshot <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> uploadTask.onComplete;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (snapshot.error <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> snapshot.ref.getDownloadURL();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (snapshot.error) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> StorageError.unknown:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.objectNotFound:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.bucketNotFound:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.projectNotFound:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.quotaExceeded:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.notAuthenticated:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.notAuthorized:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.retryLimitExceeded:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.invalidChecksum:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> StorageError.canceled:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>画像のアップロードはルーム作成時だけでなく、チャットのメッセージとしてアップロードできるようにしていますし、プロフィール画像を変更できるようにもしているので、実際のコードはアップロード先を変更する処理とか入ったり、戻りの型が違ったりしてますが、だいたいこのような感じです。<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><h3 id=firestoreに格納する>Firestoreに格納する<a class=anchorjs-link href=#firestore%e3%81%ab%e6%a0%bc%e7%b4%8d%e3%81%99%e3%82%8b></a></h3><p>ルームを保存する場所はCloud Firestoreを使っていますので、<a href=https://pub.dartlang.org/packages/cloud_firestore target=_blank>cloud_firestore</a>プラグインを使います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> createNewRoom(Room room) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> _firestore
</span></span><span style=display:flex><span>      .collection(<span style=color:#e6db74>&#39;rooms&#39;</span>)
</span></span><span style=display:flex><span>      .document(room.id)
</span></span><span style=display:flex><span>      .setData(<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>dynamic</span><span style=color:#f92672>&gt;</span>{<span style=color:#e6db74>&#39;id&#39;</span><span style=color:#f92672>:</span> room.id, <span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>:</span> room.name});
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ルーム一覧>ルーム一覧<a class=anchorjs-link href=#%e3%83%ab%e3%83%bc%e3%83%a0%e4%b8%80%e8%a6%a7></a></h2><p>ルーム一覧画面でfirestoreのroomsコレクションを監視していて、roomsコレクションにドキュメントが変更されたら更新されるようにしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>_firestore
</span></span><span style=display:flex><span>    .collection(<span style=color:#e6db74>&#39;rooms&#39;</span>)
</span></span><span style=display:flex><span>    .where(<span style=color:#75715e>/** 条件 */</span>) 
</span></span><span style=display:flex><span>    .snapshots()
</span></span><span style=display:flex><span>    .listen((querySnapshot) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// &#39;rooms&#39;に変化があったら通知される
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    });
</span></span></code></pre></div><h2 id=ルームでチャットテキスト画像の送信ができる>ルームでチャット(テキスト、画像の送信)ができる<a class=anchorjs-link href=#%e3%83%ab%e3%83%bc%e3%83%a0%e3%81%a7%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%83%86%e3%82%ad%e3%82%b9%e3%83%88%e7%94%bb%e5%83%8f%e3%81%ae%e9%80%81%e4%bf%a1%e3%81%8c%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p>ルームのイメージです。</p><p>詳細を書くとここだけで1記事になりそうなのであまり細かくは書きませんが、簡単に。</p><h3 id=チャットメッセージの表示部分>チャットメッセージの表示部分<a class=anchorjs-link href=#%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%81%ae%e8%a1%a8%e7%a4%ba%e9%83%a8%e5%88%86></a></h3><p>チャットメッセージの表示部分はListを逆順で表示しています。これは<code>ListView.builder</code>の<code>reverse</code>を<code>true</code>にすることで逆順にできます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Widget _buildListView() <span style=color:#f92672>=&gt;</span> ListView.builder(
</span></span><span style=display:flex><span>      controller: _scrollController,
</span></span><span style=display:flex><span>      reverse: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      itemCount: messages <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> messages.length <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      itemBuilder: (BuildContext context, <span style=color:#66d9ef>int</span> position) <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>          _buildMessageRow(context, position),
</span></span><span style=display:flex><span>    );
</span></span></code></pre></div><h3 id=画像を横幅いっぱいかつ角丸>画像を横幅いっぱいかつ角丸<a class=anchorjs-link href=#%e7%94%bb%e5%83%8f%e3%82%92%e6%a8%aa%e5%b9%85%e3%81%84%e3%81%a3%e3%81%b1%e3%81%84%e3%81%8b%e3%81%a4%e8%a7%92%e4%b8%b8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Widget _buildImageWidget(
</span></span><span style=display:flex><span>    BuildContext context, Message message, <span style=color:#66d9ef>int</span> position) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> SizedBox(
</span></span><span style=display:flex><span>      height: <span style=color:#ae81ff>180.0</span>,
</span></span><span style=display:flex><span>      child: Container(
</span></span><span style=display:flex><span>          padding: EdgeInsets.only(top: <span style=color:#ae81ff>8.0</span>, right: <span style=color:#ae81ff>8.0</span>, bottom: <span style=color:#ae81ff>8.0</span>),
</span></span><span style=display:flex><span>          child: GestureDetector(
</span></span><span style=display:flex><span>            onTap: () {
</span></span><span style=display:flex><span>              _onTapImage(position);
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            child: message.downloadImageUrl <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>?</span> ImageUtils.roundedImage(message.downloadImageUrl.toString())
</span></span><span style=display:flex><span>                <span style=color:#f92672>:</span> Text(Strings.of(context).uploading),
</span></span><span style=display:flex><span>          )));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ImageUtils.roundedImageの部分は以下です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>static</span> Widget roundedImage(<span style=color:#66d9ef>String</span> imageUrl) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ClipRRect(
</span></span><span style=display:flex><span>      borderRadius: BorderRadius.circular(<span style=color:#ae81ff>8.0</span>),
</span></span><span style=display:flex><span>      child: cachedImage(imageUrl, fit: BoxFit.cover));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=画像のキャッシュ>画像のキャッシュ<a class=anchorjs-link href=#%e7%94%bb%e5%83%8f%e3%81%ae%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5></a></h3><p>画像のキャッシュには<a href=https://pub.dartlang.org/packages/cached_network_image target=_blank>cached_network_image</a>プラグインを使用しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>static</span> CachedNetworkImage cachedImage(<span style=color:#66d9ef>String</span> imageUrl, {fit}) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> CachedNetworkImage(
</span></span><span style=display:flex><span>    imageUrl: imageUrl,
</span></span><span style=display:flex><span>    errorWidget: Icon(Icons.error),
</span></span><span style=display:flex><span>    fit: fit,
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=メッセージ入力部分>メッセージ入力部分<a class=anchorjs-link href=#%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e5%85%a5%e5%8a%9b%e9%83%a8%e5%88%86></a></h3><h4 id=送信タイミングでテキストをクリアするには>送信タイミングでテキストをクリアするには<a class=anchorjs-link href=#%e9%80%81%e4%bf%a1%e3%82%bf%e3%82%a4%e3%83%9f%e3%83%b3%e3%82%b0%e3%81%a7%e3%83%86%e3%82%ad%e3%82%b9%e3%83%88%e3%82%92%e3%82%af%e3%83%aa%e3%82%a2%e3%81%99%e3%82%8b%e3%81%ab%e3%81%af></a></h4><p>送信ボタンを押すタイミングで入力テキストをクリアしたいと思ったとき、次のような実装がパッと思いつくかと思います。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>_texEditingController.crear();
</span></span></code></pre></div><p>これだと日本語などの文字を入力中（確定前）に、クリアするとクラッシュしてしまいます。仕様など見たりいろいろ調べたところ、次のようにするとクラッシュしなくなりました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>_texEditingController
</span></span><span style=display:flex><span>  ..clearComposing()
</span></span><span style=display:flex><span>  ..clear();
</span></span></code></pre></div><h4 id=キーボードを閉じるには>キーボードを閉じるには<a class=anchorjs-link href=#%e3%82%ad%e3%83%bc%e3%83%9c%e3%83%bc%e3%83%89%e3%82%92%e9%96%89%e3%81%98%e3%82%8b%e3%81%ab%e3%81%af></a></h4><p>TextField部分をタップするとキーボードが表示されますが、iOSの場合はなにもしないとキーボードを閉じることができません。たとえば、チャットメッセージの表示部分をタップしてキーボードを閉じるには、チャットメッセージリスト部分を<code>GestureDetector</code>でWrapして、onTapでフォーカスを変えることで閉じることができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>GestureDetector(
</span></span><span style=display:flex><span>    onTap: () <span style=color:#f92672>=&gt;</span> FocusScope.of(context).requestFocus(FocusNode()),
</span></span><span style=display:flex><span>    child: _buildListView(),
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>focusまわりは<a href=https://flutter.io/docs/cookbook/forms/focus target=_blank>こちら</a>が参考になるかと思います。</p><h2 id=既存のルームにユーザーが参加できる>既存のルームにユーザーが参加できる<a class=anchorjs-link href=#%e6%97%a2%e5%ad%98%e3%81%ae%e3%83%ab%e3%83%bc%e3%83%a0%e3%81%ab%e3%83%a6%e3%83%bc%e3%82%b6%e3%83%bc%e3%81%8c%e5%8f%82%e5%8a%a0%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p>既存のルームに他のユーザーが参加するためには、そのルームのQRコードを読み取って参加します。</p><h3 id=qrコードを生成するには>QRコードを生成するには<a class=anchorjs-link href=#qr%e3%82%b3%e3%83%bc%e3%83%89%e3%82%92%e7%94%9f%e6%88%90%e3%81%99%e3%82%8b%e3%81%ab%e3%81%af></a></h3><p>ルームから下図のような画面を出して読み取ってもらうことにしました。</p><p>QRコード生成には<a href=https://pub.dartlang.org/packages/qr_flutter target=_blank>qr_flutter</a>プラグインを使用していて、この画面の全体のコードは下記のように実装しました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// QRコードを表示するための画面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DisplayQrCodeScreen</span> <span style=color:#66d9ef>extends</span> StatelessWidget <span style=color:#66d9ef>implements</span> Screen {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>String</span> _qrCodeData;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> DisplayQrCodeScreen(<span style=color:#66d9ef>this</span>._qrCodeData);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  Widget build(BuildContext context) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> bodyHeight <span style=color:#f92672>=</span> MediaQuery.of(context).size.height <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span>        MediaQuery.of(context).viewInsets.bottom;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Scaffold(
</span></span><span style=display:flex><span>      appBar: AppBar(
</span></span><span style=display:flex><span>        title: Text(Strings.of(context).qrCode),
</span></span><span style=display:flex><span>        backgroundColor: Colors.black,
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>      backgroundColor: Colors.black,
</span></span><span style=display:flex><span>      body: Container(
</span></span><span style=display:flex><span>        color: Colors.white,
</span></span><span style=display:flex><span>        child: Center(
</span></span><span style=display:flex><span>          child: QrImage(
</span></span><span style=display:flex><span>            version: <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>            data: _qrCodeData,
</span></span><span style=display:flex><span>            size: <span style=color:#ae81ff>0.2</span> <span style=color:#f92672>*</span> bodyHeight,
</span></span><span style=display:flex><span>          ),
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>String</span> <span style=color:#66d9ef>get</span> name <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;/qr&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>QRコードのサイズを画面の高さの20%になるように設定しました。デバイス画面サイズを取得するために、<a href=https://docs.flutter.io/flutter/widgets/MediaQuery-class.html target=_blank>MediaQuery</a>を使っています。</p><h3 id=qrコード読み取り>QRコード読み取り<a class=anchorjs-link href=#qr%e3%82%b3%e3%83%bc%e3%83%89%e8%aa%ad%e3%81%bf%e5%8f%96%e3%82%8a></a></h3><p>QRコードの表示ができたので、今度は読み取りです。本アプリでルームに参加するためには、ルームを表すQRコードを読み取る必要があります。QR読み取る方法として2種類用意しました。</p><ul><li>QRコードをカメラで読み取る</li><li>QRコード画像を開いて読み取る</li></ul><p>の2種類です。</p><h4 id=qrコードをカメラで読み取る>QRコードをカメラで読み取る<a class=anchorjs-link href=#qr%e3%82%b3%e3%83%bc%e3%83%89%e3%82%92%e3%82%ab%e3%83%a1%e3%83%a9%e3%81%a7%e8%aa%ad%e3%81%bf%e5%8f%96%e3%82%8b></a></h4><p>使用しているプラグインは<a href=https://pub.dartlang.org/packages/barcode_scan target=_blank>barcode_scan</a>です。（QRコードリーダーに関して、以前<a href=/2018/08/16/flutter-workshop/ target=_blank>ブログを書きました</a>のでご興味あればぜひ！)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>/// カメラを使ってQRコードをスキャンしてRoomに参加する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> _joinRoomWithCamera(BuildContext context) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    _roomId <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> BarcodeScanner.scan();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (error) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (error <span style=color:#66d9ef>is</span> PlatformException <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        error.code <span style=color:#f92672>==</span> BarcodeScanner.CameraAccessDenied) {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ポイントは<code>BarcodeScanner.scan()</code>だけでQRコード読み取り画面を呼び出せます。カメラアクセス許可されてない場合にエラーコードが<code>BarcodeScanner.CameraAccessDenied</code>で来るので、メッセージを出すとかするとよいかと思います。</p><h4 id=qrコード画像を開いて読み取る>QRコード画像を開いて読み取る<a class=anchorjs-link href=#qr%e3%82%b3%e3%83%bc%e3%83%89%e7%94%bb%e5%83%8f%e3%82%92%e9%96%8b%e3%81%84%e3%81%a6%e8%aa%ad%e3%81%bf%e5%8f%96%e3%82%8b></a></h4><p>こちらは最近実装したのですが、<a href=https://pub.dartlang.org/packages/firebase_ml_vision target=_blank>firebase_ml_vision</a>プラグインを使って実現しました。学習モデルをダウンロードするためアプリ容量が増えてしまうのが難点なのですが(20MBぐらい増えました)。</p><p><a href=https://pub.dartlang.org/packages/image_picker target=_blank>image_picker</a>プラグインでギャラリーからQRコード画像を開けるようにしておき、選択した画像をMLKitのBarcodeDetectorを使って検出しするという流れです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> _onImageButtonPressed(ImageSource <span style=color:#66d9ef>source</span>) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  File selectedImageFile <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> ImagePicker.pickImage(<span style=color:#66d9ef>source</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>source</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (selectedImageFile <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  FirebaseVisionImage visionImage <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      FirebaseVisionImage.fromFile(selectedImageFile);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> BarcodeDetectorOptions options <span style=color:#f92672>=</span> BarcodeDetectorOptions()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> BarcodeDetector barcodeDetector <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      FirebaseVision.instance.barcodeDetector();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Barcode<span style=color:#f92672>&gt;</span> barcodes <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> barcodeDetector.detectInImage(visionImage);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (Barcode barcode <span style=color:#66d9ef>in</span> barcodes) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> BarcodeValueType valueType <span style=color:#f92672>=</span> barcode.valueType;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (valueType) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> BarcodeValueType.text:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>String</span> value <span style=color:#f92672>=</span> barcode.displayValue;
</span></span><span style=display:flex><span>        _roomId <span style=color:#f92672>=</span> value;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>実装としてはこれで可能ですが、Androidでアプリ起動時に次のような例外が出るようになってしまいました。</p><pre tabindex=0><code>2-06 17:02:11.288  9895  9895 E AndroidRuntime: java.lang.UnsatisfiedLinkError: dalvik.system.PathClassLoader[DexPathList[[zip file &#34;/system/framework/org.apache.http.legacy.boot.jar&#34;, zip file &#34;/data/app/com.instantonnection.app-zIN5KpTkwZQRngy5QLP6ig==/base.apk&#34;],nativeLibraryDirectories=[/data/app/com.instantonnection.app-zIN5KpTkwZQRngy5QLP6ig==/lib/arm64, /data/app/com.instantonnection.app-zIN5KpTkwZQRngy5QLP6ig==/base.apk!/lib/arm64-v8a, /system/lib64]]] couldn&#39;t find &#34;libflutter.so&#34;
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at java.lang.Runtime.loadLibrary0(Runtime.java:1012)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at java.lang.System.loadLibrary(System.java:1669)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at io.flutter.view.FlutterMain.startInitialization(Unknown Source:32)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at io.flutter.view.FlutterMain.startInitialization(Unknown Source:5)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at io.flutter.app.FlutterApplication.onCreate(Unknown Source:3)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.Instrumentation.callApplicationOnCreate(Instrumentation.java:1154)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread.handleBindApplication(ActivityThread.java:5871)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread.access$1100(ActivityThread.java:199)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1650)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.os.Handler.dispatchMessage(Handler.java:106)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.os.Looper.loop(Looper.java:193)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at android.app.ActivityThread.main(ActivityThread.java:6669)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at java.lang.reflect.Method.invoke(Native Method)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493)
12-06 17:02:11.288  9895  9895 E AndroidRuntime: 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)
</code></pre><p>この対策としては、</p><p><figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/cb38beed-5f59-91ed-05d6-21ae768fb6ec.png data-action=zoom alt=image.png class=lazyload></a></figure></p><p>と設定し、ビルド時に以下のオプションをつけることで解決しました。(<a href=https://github.com/azihsoyn/flutter_mlkit/issues/36#issuecomment-421541533 target=_blank>参考</a>)</p><pre tabindex=0><code>--target-platform android-arm
</code></pre><h2 id=自分のプロフィールを見ることができる>自分のプロフィールを見ることができる<a class=anchorjs-link href=#%e8%87%aa%e5%88%86%e3%81%ae%e3%83%97%e3%83%ad%e3%83%95%e3%82%a3%e3%83%bc%e3%83%ab%e3%82%92%e8%a6%8b%e3%82%8b%e3%81%93%e3%81%a8%e3%81%8c%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p>下のように、スクロールするとヘッダーが変化するWidgetを使っています。<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><p><figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/2ef503df-0dcc-605e-d653-bfc95a2b778c.gif data-action=zoom alt=profile.gif class=lazyload></a></figure></p><p>コードはこんな感じです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Widget screen <span style=color:#f92672>=</span> Scaffold(
</span></span><span style=display:flex><span>  body: CustomScrollView(slivers: <span style=color:#f92672>&lt;</span>Widget<span style=color:#f92672>&gt;</span>[
</span></span><span style=display:flex><span>    SliverAppBar(
</span></span><span style=display:flex><span>      expandedHeight: _appBarHeight,
</span></span><span style=display:flex><span>      pinned: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      elevation: <span style=color:#ae81ff>4.0</span>,
</span></span><span style=display:flex><span>      actions: actions,
</span></span><span style=display:flex><span>      flexibleSpace: FlexibleSpaceBar(
</span></span><span style=display:flex><span>        title: Text(widget.user.name),
</span></span><span style=display:flex><span>        background: Stack(
</span></span><span style=display:flex><span>          fit: StackFit.expand,
</span></span><span style=display:flex><span>          children: <span style=color:#f92672>&lt;</span>Widget<span style=color:#f92672>&gt;</span>[
</span></span><span style=display:flex><span>            ImageUtils.cachedImage(widget.user.photoUrl.toString(),
</span></span><span style=display:flex><span>                fit: BoxFit.cover),
</span></span><span style=display:flex><span>            <span style=color:#75715e>// This gradient ensures that the toolbar icons are distinct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// against the background image.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> DecoratedBox(
</span></span><span style=display:flex><span>              decoration: BoxDecoration(
</span></span><span style=display:flex><span>                gradient: LinearGradient(
</span></span><span style=display:flex><span>                  begin: Alignment(<span style=color:#ae81ff>0.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span>),
</span></span><span style=display:flex><span>                  end: Alignment(<span style=color:#ae81ff>0.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.4</span>),
</span></span><span style=display:flex><span>                  colors: <span style=color:#f92672>&lt;</span>Color<span style=color:#f92672>&gt;</span>[Color(<span style=color:#ae81ff>0x60000000</span>), Color(<span style=color:#ae81ff>0x00000000</span>)],
</span></span><span style=display:flex><span>                ),
</span></span><span style=display:flex><span>              ),
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    SliverList(
</span></span><span style=display:flex><span>        delegate: SliverChildListDelegate(<span style=color:#f92672>&lt;</span>Widget<span style=color:#f92672>&gt;</span>[
</span></span><span style=display:flex><span>      AnnotatedRegion<span style=color:#f92672>&lt;</span>SystemUiOverlayStyle<span style=color:#f92672>&gt;</span>(
</span></span><span style=display:flex><span>          value: SystemUiOverlayStyle.dark, child: body),
</span></span><span style=display:flex><span>    ]))
</span></span><span style=display:flex><span>  ]),
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p><a href="https://www.youtube.com/watch?v=R9C5KMJKluE&amp;vl=en" target=_blank>こちらの動画</a>で雰囲気つかめるかと思います。</p><h2 id=アプリ内課金で定期購読できる>アプリ内課金で定期購読できる<a class=anchorjs-link href=#%e3%82%a2%e3%83%97%e3%83%aa%e5%86%85%e8%aa%b2%e9%87%91%e3%81%a7%e5%ae%9a%e6%9c%9f%e8%b3%bc%e8%aa%ad%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p>このアプリの目玉とも言える（笑）アプリ内課金を実装しました。使用したプラグインは<a href=https://pub.dartlang.org/packages/flutter_inapp_purchase target=_blank>flutter_inapp_purchase</a>です。</p><p>このプラグインの使い方は<a href=https://pub.dartlang.org/packages/flutter_inapp_purchase#-readme-tab- target=_blank>README</a>を見てもらうとわかるのですが、このプラグインから投げられる例外が微妙で、エラー処理がちょっと大変でした。</p><p>たとえば、下図はいったん購入しようとしたけどキャンセルした場合の例ですが、PlatformExceptionが投げれるのは良いのですが、<a href=https://github.com/dooboolab/flutter_inapp_purchase/blob/a249e5fe7563a958c19484db7988362cad3bcb1e/android/src/main/java/com/dooboolab/flutterinapppurchase/AndroidInappPurchasePlugin.java#L432 target=_blank>codeがTAG</a>になっていて、どの例外もcodeで判断できません。<figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/5f697635-f2c2-b1b4-70ee-8d431e50b970.png data-action=zoom alt=image.png class=lazyload></a></figure></p><p>よく見るとdetailsの「responseCode: 1」の<a href=https://developer.android.com/reference/com/android/billingclient/api/BillingClient.BillingResponse.html#USER_CANCELED target=_blank>1がCancelを表すエラーコード</a>になっていますので、それで判断するしか無さそうです。</p><p>先程のはAndroidでしたが、同じキャンセルでもiOSでキャンセルすると違うcodeが返ってきます。。</p><p><figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/2235b4d3-caa5-1613-4a06-718232a87857.png data-action=zoom alt=image.png class=lazyload></a></figure></p><p>なので、アプリのコードとしては以下のようにしました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span>MyPurchaseItem.PurchasedItem<span style=color:#f92672>&gt;</span> buySubscription(<span style=color:#66d9ef>String</span> productId) <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>    FlutterInappPurchase.buySubscription(productId)
</span></span><span style=display:flex><span>        .then((item) <span style=color:#f92672>=&gt;</span> _purchasedTranslator
</span></span><span style=display:flex><span>            .toModel(_translateToPurchasedItemEntity(item)))
</span></span><span style=display:flex><span>        .catchError((error) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// エラーコード統一してほしい・・・
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (Platform.isAndroid) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (error.code <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;InappPurchasePlugin&#34;</span> <span style=color:#f92672>&amp;&amp;</span> error.details <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>String</span>) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// https://developer.android.com/reference/com/android/billingclient/ap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>String</span> details <span style=color:#f92672>=</span> error.details <span style=color:#f92672>as</span> <span style=color:#66d9ef>String</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>String</span> USER_CANCELED <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1&#34;</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> (details.endsWith(USER_CANCELED)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (Platform.isIOS) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// https://github.com/dooboolab/flutter_inapp_purchase/blob/a249e5fe7563a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (error.code <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;E_USER_CANCELLED&#34;</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> error;
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>このプラグインが使えないとか言いたいわけではなくて、自分がプラグインを作るときは以下の点に気をつけたいなぁと思いました。</p><ul><li>error codeは適切なコードにする</li><li>error codeはiOS、Androidで統一する</li><li>アプリケーション側でエラーコードを変数で扱えるようにする<ul><li>たとえば<a href=https://github.com/flutter/plugins/blob/master/packages/firebase_storage/lib/src/error.dart target=_blank>こんなイメージ</a>です。</li></ul></li></ul><p>あ、アプリ内課金そのものについて触れてませんでしたね。。とはいえ、Flutterというよりそれぞれのプラットフォームの話なので詳細には触れませんが、参考リンクだけ張っておきます。</p><ul><li><a href=https://ameblo.jp/principia-ca/entry-12071725733.html target=_blank>自動購読課金について【Android編】</a></li><li><a href="https://ameblo.jp/principia-ca/entry-12071724382.html?frm=theme" target=_blank>自動購読課金について【iOS編】</a></li><li><a href=https://developer.apple.com/jp/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Chapters/Subscriptions.html target=_blank>In-App Purchaseプログラミングガイド</a></li><li><a href=https://developer.android.com/google/play/billing/api target=_blank>In-app Billing API</a></li><li><a href=https://github.com/awa/go-iap target=_blank>go-iap</a><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></li></ul><h1 id=その他-細かいけど必要な機能>その他 細かいけど必要な機能<a class=anchorjs-link href=#%e3%81%9d%e3%81%ae%e4%bb%96-%e7%b4%b0%e3%81%8b%e3%81%84%e3%81%91%e3%81%a9%e5%bf%85%e8%a6%81%e3%81%aa%e6%a9%9f%e8%83%bd></a></h1><p>細かいけど必要だったり便利な機能を見ていきたいと思います。</p><ul><li>メッセージを送信したら通知が届く</li><li>メッセージ入力中に画面を戻ってしまったなどのメッセージが消えないようにする</li><li>チャットメッセージにURLがあるとタップできてリンクを開くことができる</li><li>チャットメッセージの画像を拡大できる</li><li>チャットメッセージの画像を横スワイプで切り替えることができる</li><li>チャットメッセージの画像を上下スワイプで閉じることができる</li><li>開発者のための機能<ul><li>analytics</li><li>crashlytics</li><li>AdMob</li></ul></li><li>リリースまでに必要なの<ul><li>ランチャーアイコン</li><li>スクリーンショット</li></ul></li></ul><h2 id=メッセージを送信したら通知が届く>メッセージを送信したら通知が届く<a class=anchorjs-link href=#%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%82%92%e9%80%81%e4%bf%a1%e3%81%97%e3%81%9f%e3%82%89%e9%80%9a%e7%9f%a5%e3%81%8c%e5%b1%8a%e3%81%8f></a></h2><p><a href=https://pub.dartlang.org/packages/firebase_messaging target=_blank>firebase_messaging</a>プラグインを使って、roomIdとuserIdをトピックに登録しています。</p><p>subscribe,unsubscribeは簡単です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>FirebaseMessaging _firebaseMessaging <span style=color:#f92672>=</span> FirebaseMessaging();
</span></span><span style=display:flex><span>_firebaseMessaging.subscribeToTopic(topic);
</span></span><span style=display:flex><span>_firebaseMessaging.unsubscribeFromTopic(topic);
</span></span></code></pre></div><p>Cloud Functionsがfirestoreのメッセージコレクションを監視して、追加があったらCloud Functionsがプッシュを投げるようにしています。(Cloud FunctionsのFCMの<a href=https://github.com/firebase/functions-samples/tree/Node-8/fcm-notifications target=_blank>サンプル</a>が参考になるかと思います)</p><h2 id=メッセージ入力中に画面を戻ってしまったなどのメッセージが消えないようにする>メッセージ入力中に画面を戻ってしまったなどのメッセージが消えないようにする<a class=anchorjs-link href=#%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e5%85%a5%e5%8a%9b%e4%b8%ad%e3%81%ab%e7%94%bb%e9%9d%a2%e3%82%92%e6%88%bb%e3%81%a3%e3%81%a6%e3%81%97%e3%81%be%e3%81%a3%e3%81%9f%e3%81%aa%e3%81%a9%e3%81%ae%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%81%8c%e6%b6%88%e3%81%88%e3%81%aa%e3%81%84%e3%82%88%e3%81%86%e3%81%ab%e3%81%99%e3%82%8b></a></h2><p>長文を書いてて間違って戻ってしまった場合、長文のメッセージが消えてしまったとかはいやなので、<a href=https://pub.dartlang.org/packages/shared_preferences target=_blank>shared_preferences</a>プラグインを使って<code>dispose</code>のタイミングでローカルストレージに保存しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> saveMessage(Message message, <span style=color:#66d9ef>String</span> roomId) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  SharedPreferences prefs <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> SharedPreferences.getInstance();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> prefs.setString(
</span></span><span style=display:flex><span>      _createMessageKey(roomId), message.content);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>String</span> _createMessageKey(<span style=color:#66d9ef>String</span> roomId) <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SharedPreferenceType.message.toString()<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>$</span>roomId<span style=color:#e6db74>&#34;</span>;
</span></span></code></pre></div><p>画面に戻ってきたときは、<code>initState</code>のタイミングで保存したメッセージを読み込んでTextFieldにセットしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>String</span><span style=color:#f92672>&gt;</span> getMessage(<span style=color:#66d9ef>String</span> roomId) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>  SharedPreferences prefs <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> SharedPreferences.getInstance();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> prefs.getString(_createMessageKey(roomId));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>getMessage(widget.room.id).then((message) {
</span></span><span style=display:flex><span>  setState(() {
</span></span><span style=display:flex><span>    _texEditingController.text <span style=color:#f92672>=</span> message;
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=チャットメッセージにurlがあるとタップしてリンクを開くことができる>チャットメッセージにURLがあるとタップしてリンクを開くことができる<a class=anchorjs-link href=#%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%81%aburl%e3%81%8c%e3%81%82%e3%82%8b%e3%81%a8%e3%82%bf%e3%83%83%e3%83%97%e3%81%97%e3%81%a6%e3%83%aa%e3%83%b3%e3%82%af%e3%82%92%e9%96%8b%e3%81%8f%e3%81%93%e3%81%a8%e3%81%8c%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p><figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/37b4116e-14fc-da30-e43a-d43acf8bc124.gif data-action=zoom alt=link.gif class=lazyload></a></figure></p><p>あんまりスマートではないのですが、実装例です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Message</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>String</span> id;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>String</span> content;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>LinkText<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>get</span> linkTextList {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (content <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>LinkText<span style=color:#f92672>&gt;</span> results <span style=color:#f92672>=</span> List();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// https://stackoverflow.com/a/6041965
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RegExp exp <span style=color:#f92672>=</span> RegExp(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>r&#39;(http|https)://([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&amp;:/~+#-]*[\w@?^=%&amp;/~+#-])?&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>String</span> _content <span style=color:#f92672>=</span> content;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (_content.length <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> results;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Match match <span style=color:#f92672>=</span> exp.firstMatch(_content);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (match <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        results.add(LinkText(_content));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> results;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// urlが見つかるまでにテキストがあれば追加する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>String</span> str <span style=color:#f92672>=</span> _content.substring(<span style=color:#ae81ff>0</span>, match.start);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (str.length <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        results.add(LinkText(str));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>String</span> url <span style=color:#f92672>=</span> match.group(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>      results.add(LinkText(url, url: url));
</span></span><span style=display:flex><span>      _content <span style=color:#f92672>=</span> _content.substring(match.end, _content.length);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>while</span> (_content.length <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> results;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Message(<span style=color:#66d9ef>this</span>.id, <span style=color:#66d9ef>this</span>.content);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LinkText</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>String</span> text;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>String</span> url;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  LinkText(<span style=color:#66d9ef>this</span>.text, {<span style=color:#66d9ef>this</span>.url});
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Messageクラスのcontentに入力したメッセージが入る想定で、Widget側で次のように使っています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Widget _buildMessageWidget(BuildContext context, Message message) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> TextStyle aboutTextStyle <span style=color:#f92672>=</span> Theme.of(context).textTheme.body2;
</span></span><span style=display:flex><span>  List<span style=color:#f92672>&lt;</span>TextSpan<span style=color:#f92672>&gt;</span> children <span style=color:#f92672>=</span> message.linkTextList.map((linkText) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// textがnullではなくurlがnullならリンクにしない。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// textもurlもnullではない場合、urlに遷移するリンクにする。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (linkText.url <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> TextSpan(style: aboutTextStyle, text: linkText.text);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> LinkTextSpan(
</span></span><span style=display:flex><span>        context: context, text: linkText.text, url: linkText.url);
</span></span><span style=display:flex><span>  }).toList();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Container(
</span></span><span style=display:flex><span>    child: RichText(
</span></span><span style=display:flex><span>      text: TextSpan(
</span></span><span style=display:flex><span>        style: TextStyle(fontSize: <span style=color:#ae81ff>16.0</span>),
</span></span><span style=display:flex><span>        children: children,
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>LinkTextSpanクラスは次のとおりです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:flutter/gestures.dart&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:url_launcher/url_launcher.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// https://github.com/flutter/flutter/blob/master/examples/flutter_gallery/lib/gallery/about.dart#L11-L33
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LinkTextSpan</span> <span style=color:#66d9ef>extends</span> TextSpan {
</span></span><span style=display:flex><span>  LinkTextSpan(
</span></span><span style=display:flex><span>      {BuildContext context,
</span></span><span style=display:flex><span>      TextStyle style,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>String</span> url,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>String</span> text,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>bool</span> inAppWebView <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>})
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> <span style=color:#66d9ef>super</span>(
</span></span><span style=display:flex><span>            style: style <span style=color:#f92672>??</span> url <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>?</span> TextStyle(
</span></span><span style=display:flex><span>                    color: Colors.blue,
</span></span><span style=display:flex><span>                    decoration: TextDecoration.underline,
</span></span><span style=display:flex><span>                  )
</span></span><span style=display:flex><span>                <span style=color:#f92672>:</span> Theme.of(context).textTheme.body2,
</span></span><span style=display:flex><span>            text: text <span style=color:#f92672>??</span> url,
</span></span><span style=display:flex><span>            recognizer: TapGestureRecognizer()
</span></span><span style=display:flex><span>              ..onTap <span style=color:#f92672>=</span> () {
</span></span><span style=display:flex><span>                launch(url, forceWebView: inAppWebView);
</span></span><span style=display:flex><span>              });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>launch</code>は<a href=https://pub.dartlang.org/packages/url_launcher target=_blank>url_launcher</a>プラグインで、URLを開くことができます。</p><h2 id=チャットメッセージの画像を拡大できる>チャットメッセージの画像を拡大できる<a class=anchorjs-link href=#%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%81%ae%e7%94%bb%e5%83%8f%e3%82%92%e6%8b%a1%e5%a4%a7%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p>画像の拡大には<a href=https://pub.dartlang.org/packages/photo_view target=_blank>photo_view</a>プラグインを使っています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Container(
</span></span><span style=display:flex><span>  child: Center(
</span></span><span style=display:flex><span>    child: PhotoView(
</span></span><span style=display:flex><span>      imageProvider: NetworkImage(imageUrl),
</span></span><span style=display:flex><span>      minScale: PhotoViewComputedScale.contained <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>      maxScale: <span style=color:#ae81ff>2.0</span>,
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>  ),
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h2 id=チャットメッセージの画像を横スワイプで切り替えることができる>チャットメッセージの画像を横スワイプで切り替えることができる<a class=anchorjs-link href=#%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%81%ae%e7%94%bb%e5%83%8f%e3%82%92%e6%a8%aa%e3%82%b9%e3%83%af%e3%82%a4%e3%83%97%e3%81%a7%e5%88%87%e3%82%8a%e6%9b%bf%e3%81%88%e3%82%8b%e3%81%93%e3%81%a8%e3%81%8c%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p><figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/30e120ef-cde9-d9fb-8371-86b7ea1e59eb.gif data-action=zoom alt=swipe.gif class=lazyload></a></figure></p><p>画像を横スワイプで切り替えるのに、<a href=https://docs.flutter.io/flutter/material/DefaultTabController-class.html target=_blank>DefaultTabController</a>と<a href=https://docs.flutter.io/flutter/material/TabBarView-class.html target=_blank>TabBarView</a>クラスを組み合わせて使っています。</p><p>全体のコードはこちらの<a href=https://gist.github.com/kwmt/ba4701b2b80b3675e7c58ea9b841f45f target=_blank>gist</a>を見ていただければと思いますが、雰囲気は下記のような感じです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>DefaultTabController(
</span></span><span style=display:flex><span>      initialIndex: position,
</span></span><span style=display:flex><span>      length: imageUrls.length,
</span></span><span style=display:flex><span>      child: _PageSelector(imageUrls: imageUrls, position: position),
</span></span><span style=display:flex><span>    );
</span></span></code></pre></div><p><code>_PageSelector</code>はStatelessWidgetになっていて、下記を実装しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>child: TabBarView(
</span></span><span style=display:flex><span>    children: imageUrls.map((<span style=color:#66d9ef>String</span> imageUrl) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Container(
</span></span><span style=display:flex><span>    child: Center(
</span></span><span style=display:flex><span>      child: PhotoView(
</span></span><span style=display:flex><span>        imageProvider: NetworkImage(imageUrl),
</span></span><span style=display:flex><span>        minScale: PhotoViewComputedScale.contained <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.0</span>,
</span></span><span style=display:flex><span>        maxScale: <span style=color:#ae81ff>2.0</span>,
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}).toList()),
</span></span></code></pre></div><h2 id=チャットメッセージの画像を上下スワイプで閉じることができる>チャットメッセージの画像を上下スワイプで閉じることができる<a class=anchorjs-link href=#%e3%83%81%e3%83%a3%e3%83%83%e3%83%88%e3%83%a1%e3%83%83%e3%82%bb%e3%83%bc%e3%82%b8%e3%81%ae%e7%94%bb%e5%83%8f%e3%82%92%e4%b8%8a%e4%b8%8b%e3%82%b9%e3%83%af%e3%82%a4%e3%83%97%e3%81%a7%e9%96%89%e3%81%98%e3%82%8b%e3%81%93%e3%81%a8%e3%81%8c%e3%81%a7%e3%81%8d%e3%82%8b></a></h2><p><figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/abf30870-8ecf-e758-bcfe-736ec74e1d96.gif data-action=zoom alt=dismissable.gif class=lazyload></a></figure></p><p>画面全体のWidget(ここではScaffold)を<a href=https://docs.flutter.io/flutter/widgets/Dismissible-class.html target=_blank><code>Dismissable</code></a>でWrapするだけです。<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span> Dismissible(
</span></span><span style=display:flex><span>  key: key,
</span></span><span style=display:flex><span>  direction: DismissDirection.vertical,
</span></span><span style=display:flex><span>  onDismissed: (direction) {
</span></span><span style=display:flex><span>    Navigator.pop(context);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  child: Scaffold(appBar: AppBar(<span style=color:#960050;background-color:#1e0010>省略</span>...
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h2 id=開発者のための機能>開発者のための機能<a class=anchorjs-link href=#%e9%96%8b%e7%99%ba%e8%80%85%e3%81%ae%e3%81%9f%e3%82%81%e3%81%ae%e6%a9%9f%e8%83%bd></a></h2><h3 id=analytics>analytics<a class=anchorjs-link href=#analytics></a></h3><p>GoogleAnalyticsも<a href=https://pub.dartlang.org/packages/firebase_analytics target=_blank>firebase_analytics</a>プラグインがあって、スクリーン名やイベントを取ることができます。</p><h3 id=crashlytics>crashlytics<a class=anchorjs-link href=#crashlytics></a></h3><p>crashlyticsはGoogle公式ではありませんが、<a href=https://pub.dartlang.org/packages/flutter_crashlytics target=_blank>flutter_crashlytics</a>プラグインがあります。<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup><sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup></p><h3 id=admob>AdMob<a class=anchorjs-link href=#admob></a></h3><p>広告を表示するために、<a href=https://pub.dartlang.org/packages/firebase_admob target=_blank>firebase_admob</a>を使用しました。バナー、インタースティシャル、リワードに対応していますが、READMEの<a href=https://github.com/flutter/plugins/tree/master/packages/firebase_admob#limitations target=_blank>limitations</a>に書いてあるようにいくつか制限があります。
バナー広告は画面の上か下しか配置できなかったり、リストの途中に広告を挟むことができないのは使えないと思うかも知れませんが、<a href=https://medium.com/flutter-community/flutter-platformview-how-to-create-flutter-widgets-from-native-views-366e378115b6 target=_blank>PlatformView</a>がAndroid、iOSに対応したので今後に期待しています。(<a href=https://qiita.com/kikuchy/items/397b7664ad32656748bf target=_blank>先日のアドベントカレンダーにも投稿されましたね</a>)</p><p>今回バナーはデザイン的に使いたくなったので、インタースティシャル広告を実装しました。
ルームやプロフィールを編集する画面があるのですが、その編集画面に遷移するタイミングで20%の確率で広告を表示しています。</p><p>プロフィール画面のinitStateでloadします</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> loadInterstitial() {
</span></span><span style=display:flex><span>  _interstitialAd<span style=color:#f92672>?</span>.dispose();
</span></span><span style=display:flex><span>  _interstitialAd <span style=color:#f92672>=</span> _createInterstitialAd()..load();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Future.value(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>InterstitialAd _createInterstitialAd() <span style=color:#f92672>=&gt;</span> InterstitialAd(
</span></span><span style=display:flex><span>      adUnitId: _appConfig.adMobIds.interstitialUnitId,
</span></span><span style=display:flex><span>      listener: (MobileAdEvent event) {},
</span></span><span style=display:flex><span>    );
</span></span></code></pre></div><p>編集画面へ遷移するボタンタップ時のタイミングで広告を表示しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Future<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> showInterstitial() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> _interstitialAd.isLoaded().then((loaded) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (loaded) {
</span></span><span style=display:flex><span>      _interstitialAd<span style=color:#f92672>?</span>.show();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ちなみに20%の確率の実装は<a href=https://api.dartlang.org/stable/2.1.0/dart-math/Random-class.html target=_blank><code>Random</code></a>を使うとよさそうです。<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>Random().nextInt(<span style=color:#ae81ff>100</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div><h2 id=リリースまでに必要なの>リリースまでに必要なの<a class=anchorjs-link href=#%e3%83%aa%e3%83%aa%e3%83%bc%e3%82%b9%e3%81%be%e3%81%a7%e3%81%ab%e5%bf%85%e8%a6%81%e3%81%aa%e3%81%ae></a></h2><h3 id=ランチャーアイコン>ランチャーアイコン<a class=anchorjs-link href=#%e3%83%a9%e3%83%b3%e3%83%81%e3%83%a3%e3%83%bc%e3%82%a2%e3%82%a4%e3%82%b3%e3%83%b3></a></h3><p>ランチャーアイコン（アプリアイコン）はリリースまでには必要になるのですが、サイズが細かく決まってたりしてなれてないと（なれてても？）アイコン作成は大変です。それを便利にするのが、<a href=https://pub.dartlang.org/packages/flutter_launcher_icons target=_blank>flutter_launcher_icons</a>プラグインです。</p><p>(私の場合は)1024x1024の画像を1つだけ作ってpubspec.yamlに次のように書いて実行すると、Android,iOSの解像度別のアイコンをすべて作成してくれます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>flutter_launcher_icons</span>: <span style=color:#e6db74>&#34;^0.6.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>flutter_icons</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>android</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ios</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image_path</span>: <span style=color:#e6db74>&#34;assets/images/launcher-icons/icon-1024x1024.png&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>adaptive_icon_background</span>: <span style=color:#e6db74>&#34;#FFFFFF&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>adaptive_icon_foreground</span>: <span style=color:#e6db74>&#34;assets/images/launcher-icons/icon-1024x1024.png&#34;</span>
</span></span></code></pre></div><h3 id=スクリーンショット>スクリーンショット<a class=anchorjs-link href=#%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88></a></h3><p>これもリリースまでには必要になります。こちらはプラグインではないのですが、<code>flutter screenshot</code>コマンドが便利だったのでご紹介。</p><p>いつもならAndroid Studioと端末をつなげてLogCatからScreen Captureするとか、端末側でスクショとって画像をPCに送るとかしていたのが不要になります。</p><p>PCと端末つなげて<code>flutter screenshot</code>を実行するだけでスクショを撮ってくれます。これは普通にAndroid,iOS開発中にも使えるので、オススメです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% flutter screenshot
</span></span><span style=display:flex><span>Screenshot written to flutter_03.png <span style=color:#f92672>(</span>160kB<span style=color:#f92672>)</span>.
</span></span></code></pre></div><h1 id=紹介した時点でのプラグインのバージョン一覧>紹介した時点でのプラグインのバージョン一覧<a class=anchorjs-link href=#%e7%b4%b9%e4%bb%8b%e3%81%97%e3%81%9f%e6%99%82%e7%82%b9%e3%81%a7%e3%81%ae%e3%83%97%e3%83%a9%e3%82%b0%e3%82%a4%e3%83%b3%e3%81%ae%e3%83%90%e3%83%bc%e3%82%b8%e3%83%a7%e3%83%b3%e4%b8%80%e8%a6%a7></a></h1><table><thead><tr><th style=text-align:left>プラグイン</th><th style=text-align:left>　バージョン</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/google_sign_in target=_blank>google_sign_in</a></td><td style=text-align:left>3.2.4</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/firebase_auth target=_blank>firebase_auth</a></td><td style=text-align:left>0.15.4</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/cloud_firestore target=_blank>cloud_firestore</a></td><td style=text-align:left>0.8.2+3</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/firebase_messaging target=_blank>firebase_messaging</a></td><td style=text-align:left>2.1.0</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/flutter_facebook_login target=_blank>flutter_facebook_login</a></td><td style=text-align:left>1.1.1</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/firebase_storage target=_blank>firebase_storage</a></td><td style=text-align:left>1.0.4</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/firebase_analytics target=_blank>firebase_analytics</a></td><td style=text-align:left>1.0.6</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/firebase_admob target=_blank>firebase_admob</a></td><td style=text-align:left>0.7.0</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/firebase_ml_vision target=_blank>firebase_ml_vision</a></td><td style=text-align:left>0.2.0+2</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/flutter_crashlytics target=_blank>flutter_crashlytics</a></td><td style=text-align:left>0.1.1</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/image_picker target=_blank>image_picker</a></td><td style=text-align:left>0.4.10</td></tr><tr><td style=text-align:left><a href=https://github.com/btastic/flutter_native_image target=_blank>flutter_native_image</a></td><td style=text-align:left>commit 20947f19<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup></td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/photo_view target=_blank>photo_view</a></td><td style=text-align:left>0.1.0</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/cached_network_image target=_blank>cached_network_image</a></td><td style=text-align:left>0.4.2</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/barcode_scan target=_blank>barcode_scan</a></td><td style=text-align:left>0.0.8</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/qr_flutter target=_blank>qr_flutter</a></td><td style=text-align:left>1.1.5</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/url_launcher target=_blank>url_launcher</a></td><td style=text-align:left>4.0.2</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/flutter_inapp_purchase target=_blank>flutter_inapp_purchase</a></td><td style=text-align:left>0.8.5</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/shared_preferences target=_blank>shared_preferences</a></td><td style=text-align:left>0.4.3</td></tr><tr><td style=text-align:left><a href=https://pub.dartlang.org/packages/flutter_launcher_icons target=_blank>flutter_launcher_icons</a></td><td style=text-align:left>0.7.0</td></tr></tbody></table><h1 id=本アプリのリリースについて>本アプリのリリースについて<a class=anchorjs-link href=#%e6%9c%ac%e3%82%a2%e3%83%97%e3%83%aa%e3%81%ae%e3%83%aa%e3%83%aa%e3%83%bc%e3%82%b9%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6></a></h1><p>ここまでお読みいただいた方はもしかしたら触ってみたくなったかもしれませんので、リリース状況についてお伝えします。</p><h2 id=android>Android<a class=anchorjs-link href=#android></a></h2><p>本日バージョン1.0.0リリースです🎉 <sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup></p><h2 id=ios>iOS<a class=anchorjs-link href=#ios></a></h2><p>iOSはAppStoreに審査出しました。<figure><a class=paragraph-image><img data-src=https://qiita-image-store.s3.amazonaws.com/0/22161/f52a10ae-334b-3092-e60c-7afb994479a2.png data-action=zoom alt=image.png class=lazyload></a></figure></p><p>が、<a href=https://developer.apple.com/jp/app-store/review/guidelines/#design target=_blank>Designガイドライン</a>に引っかかってリジェクトされました。
おそらくオリジナリティがないとのことだと思うので、AppStoreへのリリースは当分先になるかもしれません。</p><p>2019/08/02追記
iOSは3月にAppStoreにリリースできました。リンク貼るの遅くなりました。。。</p><p></p><p>ちなみに、上記のオリジナリティがないというリジェクトの対応は、オンボーディングをつけることで通りました。</p><h1 id=ソースコードについて-20200229追記>ソースコードについて ※2020/02/29追記<a class=anchorjs-link href=#%e3%82%bd%e3%83%bc%e3%82%b9%e3%82%b3%e3%83%bc%e3%83%89%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6-20200229%e8%bf%bd%e8%a8%98></a></h1><p>ここで紹介したチャットアプリのコードをオープンソースにしましたので、全体的なコードを知りたい方はこちらをご覧ください。
<a href=https://github.com/kwmt/flutter-inconne target=_blank>https://github.com/kwmt/flutter-inconne</a>
PR、issue、<strong>スター☆</strong>はWelcomeです！</p><h1 id=おわりに>おわりに<a class=anchorjs-link href=#%e3%81%8a%e3%82%8f%e3%82%8a%e3%81%ab></a></h1><p>以上、いかがでしたでしょうか。おそらくチャットアプリでの主要な機能については一通りご紹介できたんじゃないかなと思っていますので、この記事読んでチャットアプリが作れそう！と思ってもらえたら嬉しく思います。</p><p>チャット機能のみのアプリだとapple様にリジェクトされるようなので、なにかメイン機能+チャット機能とするのがいいのかもしれません。</p><p>この記事がFlutter開発者のみなさんの助けになれば幸いです。
ここまでお読み頂きありがとうございました。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>safe areaにかぶっているので調整が必要かもしれません。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>firebase_storageプラグインのv1.0.3で<a href=https://github.com/flutter/plugins/pull/531/files#diff-64e1f7ca1659a9f092f80ba64377fbefL17 target=_blank>使い方が変わり</a>、取り急ぎ修正した感じなのでもしかしたらもっと良いやり方があるかも知れません。また、プラグインのexampleには<code>StreamBuilder</code>の使い方が書いてありますが、<code>StreamBuilder</code>を使うと表示とアップロード処理の分離できなさそうだったので使いたくありませんでした。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>使ってみたかっただけです。&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>定期購読が停止されてるかどうかをチェックするためのサーバーをGoで作成しましたが、そのときに使わせてもらったライブラリです。&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>簡単すぎて感動しました!&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/flutter/flutter/issues/14765 target=_blank>issue</a>があります。公式サポートしてほしいと思っている人たちは多そうなので期待しています。&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p>Flutterプロジェクトが古いとiOSでビルドできない状態になってました。Podfileが少し変わった？ようで、その部分を変えたらビルドできるようになりました。新しいプロジェクトなら動くかと思います。&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><code>import 'dart:math';</code>が必要です。&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p><a href=https://pub.dartlang.org/ target=_blank>https://pub.dartlang.org/</a> に公開されていないので、コミット番号にしています。&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:10><p>と、言ってみたかった。
&#160;<a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/2020/03/26/i-tried-to-use-dep-in-my-library/ data-toggle=tooltip data-placement=top title="dep(Go dependency tool)を自作ライブラリに使ってみた">Previous<br><span>dep(Go dependency tool)を自作ライブラリに使ってみた</span></a></li><li class=next><a href=/2020/03/26/summary-of-screen-transitions-in-flutter/ data-toggle=tooltip data-placement=top title=Flutterでの画面遷移まとめ>Next<br><span>Flutterでの画面遷移まとめ</span></a></li></ul><hr style=visibility:hidden><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kwmt27.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div class=giscus id=comments></div><script src=https://giscus.app/client.js data-repo data-repo-id=kwmt27 data-category=General data-category-id data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/tags/1.2/>1.2</a>
<a href=/tags/1.2-rc1/>1.2 rc1</a>
<a href=/tags/adb/>adb</a>
<a href=/tags/advent-calendar/>Advent Calendar</a>
<a href=/tags/ambient/>Ambient</a>
<a href=/tags/android/>Android</a>
<a href=/tags/android-n/>Android N</a>
<a href=/tags/android-studio/>Android Studio</a>
<a href=/tags/android-studio-3.6/>Android Studio 3.6</a>
<a href=/tags/android-wear/>android wear</a>
<a href=/tags/androiddevchallenge/>AndroidDevChallenge</a>
<a href=/tags/androidstudio/>AndroidStudio</a>
<a href=/tags/android%E7%A0%94%E7%A9%B6%E7%99%BA%E8%A1%A8%E4%BC%9A/>Android研究&発表会</a>
<a href=/tags/animation/>Animation</a>
<a href=/tags/archive/zip/>archive/zip</a>
<a href=/tags/arduino/>Arduino</a>
<a href=/tags/aws/>AWS</a>
<a href=/tags/beacon/>beacon</a>
<a href=/tags/billing/>Billing</a>
<a href=/tags/bitmap/>Bitmap</a>
<a href=/tags/camera2/>Camera2</a>
<a href=/tags/camerax/>CameraX</a>
<a href=/tags/cd/>CD</a>
<a href=/tags/ci/>CI</a>
<a href=/tags/ci/>CI</a>
<a href=/tags/clean-architecture/>Clean Architecture</a>
<a href=/tags/cloud-vision-api/>Cloud Vision API</a>
<a href=/tags/codelab/>codelab</a>
<a href=/tags/compose/>Compose</a>
<a href=/tags/compress/bzip2/>compress/bzip2</a>
<a href=/tags/coroutine/>coroutine</a>
<a href=/tags/css/>CSS</a>
<a href=/tags/dagger2/>Dagger2</a>
<a href=/tags/dark-theme/>Dark Theme</a>
<a href=/tags/dart/>Dart</a>
<a href=/tags/dart2/>dart2</a>
<a href=/tags/databinding/>Databinding</a>
<a href=/tags/deeplearning/>DeepLearning</a>
<a href=/tags/delegate/>Delegate</a>
<a href=/tags/docker/>Docker</a>
<a href=/tags/eclipse/>Eclipse</a>
<a href=/tags/encoding/base64/>encoding/base64</a>
<a href=/tags/encoding/json/>encoding/json</a>
<a href=/tags/enum/>enum</a>
<a href=/tags/fabric-sdk/>Fabric SDK</a>
<a href=/tags/fcm/>FCM</a>
<a href=/tags/firebase/>Firebase</a>
<a href=/tags/firestore/>Firestore</a>
<a href=/tags/flow/>Flow</a>
<a href=/tags/flutter/>flutter</a>
<a href=/tags/flutter_inapp_purchase/>flutter_inapp_purchase</a>
<a href=/tags/flutter_web/>flutter_web</a>
<a href=/tags/gae/go/>GAE/Go</a>
<a href=/tags/gcm/>GCM</a>
<a href=/tags/gdgkobe/>gdgkobe</a>
<a href=/tags/gds/>GDS</a>
<a href=/tags/genmai/>Genmai</a>
<a href=/tags/gin/>gin</a>
<a href=/tags/git/>git</a>
<a href=/tags/go/>Go</a>
<a href=/tags/gocon/>gocon</a>
<a href=/tags/godoc/>godoc</a>
<a href=/tags/golang/>golang</a>
<a href=/tags/google+api/>Google+API</a>
<a href=/tags/google-i/o-2018/>Google I/O 2018</a>
<a href=/tags/google-mapa-api/>Google Mapa API</a>
<a href=/tags/google-maps-api/>Google Maps API</a>
<a href=/tags/google-play/>Google Play</a>
<a href=/tags/google-signin/>Google SignIn</a>
<a href=/tags/googlei/o-2019/>GoogleI/O 2019</a>
<a href=/tags/googlemap/>GoogleMap</a>
<a href=/tags/go%E8%A8%80%E8%AA%9E/>Go言語</a>
<a href=/tags/greendao/>greenDao</a>
<a href=/tags/heroku/>Heroku</a>
<a href=/tags/hugo/>Hugo</a>
<a href=/tags/icon/>icon</a>
<a href=/tags/image/>image</a>
<a href=/tags/intellij-idea/>Intellij IDEA</a>
<a href=/tags/ios/>iOS</a>
<a href=/tags/java/>Java</a>
<a href=/tags/jenkins/>Jenkins</a>
<a href=/tags/jetpack/>Jetpack</a>
<a href=/tags/jquery/>Jquery</a>
<a href=/tags/json-schema/>JSON Schema</a>
<a href=/tags/kotlin/>Kotlin</a>
<a href=/tags/kug2/>kug2</a>
<a href=/tags/layout/>layout</a>
<a href=/tags/lifecycle/>Lifecycle</a>
<a href=/tags/line/>Line</a>
<a href=/tags/linebot/>linebot</a>
<a href=/tags/lint/>Lint</a>
<a href=/tags/livedata/>LiveData</a>
<a href=/tags/lt/>LT</a>
<a href=/tags/macos/>macOS</a>
<a href=/tags/map/>map</a>
<a href=/tags/mockito2/>Mockito2</a>
<a href=/tags/mysql/>MySQL</a>
<a href=/tags/navigation/>Navigation</a>
<a href=/tags/net/http/fcgi/>net/http/fcgi</a>
<a href=/tags/net/smtp/>net/smtp</a>
<a href=/tags/nginx/>Nginx</a>
<a href=/tags/node.js/>Node.js</a>
<a href=/tags/okhttp/>OkHttp</a>
<a href=/tags/openid/>OpenID</a>
<a href=/tags/oreo/>Oreo</a>
<a href=/tags/package/>package</a>
<a href=/tags/php/>PHP</a>
<a href=/tags/pil/>PIL</a>
<a href=/tags/plant-uml/>Plant UML</a>
<a href=/tags/polymer/>polymer</a>
<a href=/tags/provider/>Provider</a>
<a href=/tags/push%E9%80%9A%E7%9F%A5/>Push通知</a>
<a href=/tags/python/>python</a>
<a href=/tags/pythonchallenge/>pythonchallenge</a>
<a href=/tags/reflect/>reflect</a>
<a href=/tags/retrofit/>Retrofit</a>
<a href=/tags/retrofit2/>Retrofit2</a>
<a href=/tags/riot.js/>Riot.js</a>
<a href=/tags/room/>Room</a>
<a href=/tags/runtime/>runtime</a>
<a href=/tags/rxjava/>RxJava</a>
<a href=/tags/s3/>S3</a>
<a href=/tags/sensor/>Sensor</a>
<a href=/tags/server/>Server</a>
<a href=/tags/sketch/>sketch</a>
<a href=/tags/state/>State</a>
<a href=/tags/statusbar/>StatusBar</a>
<a href=/tags/strconv/>strconv</a>
<a href=/tags/strings/>strings</a>
<a href=/tags/struct/>struct</a>
<a href=/tags/sublime-text/>Sublime Text</a>
<a href=/tags/swift/>swift</a>
<a href=/tags/swiftui/>SwiftUI</a>
<a href=/tags/targetsdkversiion/>targetSdkVersiion</a>
<a href=/tags/template/>template</a>
<a href=/tags/tensorflow/>Tensorflow</a>
<a href=/tags/test/>test</a>
<a href=/tags/textformfield/>TextFormField</a>
<a href=/tags/topic/>topic</a>
<a href=/tags/twitter/>Twitter</a>
<a href=/tags/unicode/utf8/>unicode/utf8</a>
<a href=/tags/vagrant/>Vagrant</a>
<a href=/tags/view-binding/>View Binding</a>
<a href=/tags/viewmodel/>ViewModel</a>
<a href=/tags/volley/>Volley</a>
<a href=/tags/vps/>VPS</a>
<a href=/tags/web-api/>Web API</a>
<a href=/tags/webview/>WebView</a>
<a href=/tags/wercker/>wercker</a>
<a href=/tags/wercker-step/>wercker-step</a>
<a href=/tags/windows/>windows</a>
<a href=/tags/wordpress/>wordpress</a>
<a href=/tags/xcode/>xcode</a>
<a href=/tags/y/>y</a>
<a href=/tags/%E3%82%A2%E3%83%97%E3%83%AA%E5%86%85%E8%AA%B2%E9%87%91/>アプリ内課金</a>
<a href=/tags/%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88/>イベント</a>
<a href=/tags/%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%BF/>エミュレータ</a>
<a href=/tags/%E3%82%B7%E3%83%A7%E3%83%BC%E3%83%88%E3%82%AB%E3%83%83%E3%83%88%E3%82%AD%E3%83%BC/>ショートカットキー</a>
<a href=/tags/%E3%82%B7%E3%83%B3%E3%82%BF%E3%83%83%E3%82%AF%E3%82%B9%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88/>シンタックスハイライト</a>
<a href=/tags/%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB/>スクロール</a>
<a href=/tags/%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%90%E3%83%83%E3%83%89/>トラックバッド</a>
<a href=/tags/%E3%83%97%E3%83%A9%E3%82%A4%E3%83%90%E3%82%B7%E3%83%BC%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC/>プライバシーポリシー</a>
<a href=/tags/%E3%83%A1%E3%83%AB%E3%83%81%E3%83%A3%E3%83%AA/>メルチャリ</a>
<a href=/tags/%E3%83%A2%E3%83%90%E3%82%82%E3%81%8F%E4%BC%9A/>モバもく会</a>
<a href=/tags/%E4%BD%93%E9%A8%93/>体験</a>
<a href=/tags/%E5%8B%89%E5%BC%B7%E4%BC%9A/>勉強会</a>
<a href=/tags/%E6%8C%AF%E3%82%8A%E8%BF%94%E3%82%8A/>振り返り</a>
<a href=/tags/%E6%97%85%E8%A1%8C%E8%A8%98/>旅行記</a>
<a href=/tags/%E6%97%A5%E8%A8%98/>日記</a>
<a href=/tags/%E6%A9%9F%E4%BC%9A%E5%AD%A6%E7%BF%92/>機会学習</a>
<a href=/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/>機械学習</a>
<a href=/tags/%E7%99%BB%E5%A3%87/>登壇</a>
<a href=/tags/%E7%BF%BB%E8%A8%B3/>翻訳</a>
<a href=/tags/%E8%A7%92%E4%B8%B8/>角丸</a>
<a href=/tags/%E8%A8%AD%E5%AE%9A%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88/>設定切り替え</a>
<a href=/tags/%E9%96%A2%E3%83%A2%E3%83%90/>関モバ</a>
<a href=/tags/%E9%98%AAgo/>阪Go</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=https://github.com/kwmt target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/yasi_kawamoto target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Androg 2023<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/js/simple-jekyll-search.min.js></script>
<script src=/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script>
<script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")})</script><script type=text/javascript src=/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js></script>
<script>$(document).ready(function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-39334884-1","auto"),ga("send","pageview"))</script><script src=/zoomjs/zoom.min.js></script></body></html>